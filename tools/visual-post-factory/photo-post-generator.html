<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>HelloComp Photo Post Factory v6 ASSET × Heureka</title>
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap");

        :root {
            --brand: #2166CC;
            --brand-light: #4d8ee8;
            --accent: #00d4ff;
            --neon-purple: #a855f7;
            --success: #10b981;
            --text: #f0f2f5;
            --muted: #8b95a5;
            --surface: #0c0f14;
            --panel-bg: rgba(8, 10, 16, .94);
            --stroke: rgba(255, 255, 255, .1)
        }

        * {
            box-sizing: border-box;
            margin: 0
        }

        body {
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            background: #070a0e;
            color: var(--text);
            height: 100vh;
            overflow: hidden
        }

        .app {
            display: grid;
            grid-template-columns: 360px 1fr;
            height: 100%
        }

        .panel {
            background: var(--panel-bg);
            border-right: 1px solid var(--stroke);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            padding: 14px;
            gap: 8px;
            overflow-y: auto
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--stroke)
        }

        .panel-header .logo-img {
            height: 26px;
            width: auto;
            opacity: .95;
            filter: brightness(0) invert(1)
        }

        .panel-header .version {
            font-size: 10px;
            color: var(--accent);
            margin-left: auto;
            background: linear-gradient(135deg, rgba(0, 212, 255, .12), rgba(168, 85, 247, .12));
            padding: 2px 8px;
            border-radius: 6px;
            border: 1px solid rgba(0, 212, 255, .2);
            font-weight: 800;
            letter-spacing: .05em;
            animation: versionGlow 3s ease-in-out infinite
        }

        .section-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-top: 4px
        }

        .btn-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .btn {
            border: 1px solid rgba(255, 255, 255, .15);
            background: linear-gradient(135deg, var(--brand), rgba(33, 102, 204, .7));
            color: #fff;
            border-radius: 8px;
            padding: 7px 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: .03em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all .15s;
            font-family: inherit
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px)
        }

        .btn:active {
            transform: translateY(0)
        }

        .btn.secondary {
            background: rgba(255, 255, 255, .07);
            color: #c8d0dc
        }

        .btn.success {
            background: linear-gradient(135deg, #059669, #10b981)
        }

        .btn.export {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            position: relative;
            overflow: hidden
        }

        .btn.export::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 40%;
            height: 200%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .2), transparent);
            transform: skewX(-25deg);
            animation: btnShine 3s ease-in-out infinite
        }

        .btn.small {
            padding: 5px 8px;
            font-size: 10px
        }

        input.field,
        select.field {
            width: 100%;
            border: 1px solid var(--stroke);
            background: rgba(0, 0, 0, .4);
            color: var(--text);
            border-radius: 8px;
            padding: 7px 10px;
            font-size: 11px;
            font-family: inherit;
            outline: none
        }

        input.field:focus,
        select.field:focus {
            border-color: var(--brand)
        }

        textarea.field {
            width: 100%;
            flex: 1;
            min-height: 80px;
            resize: none;
            border: 1px solid var(--stroke);
            background: rgba(0, 0, 0, .4);
            color: #dde3ed;
            border-radius: 8px;
            padding: 8px;
            font-family: "SF Mono", ui-monospace, monospace;
            font-size: 10px;
            line-height: 1.4;
            outline: none
        }

        textarea.field:focus {
            border-color: var(--brand)
        }

        .status-bar {
            font-size: 11px;
            color: var(--muted);
            padding: 4px 0;
            min-height: 1.4em
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(40px) scale(.95)
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(.85)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% center
            }

            100% {
                background-position: 200% center
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-8px)
            }
        }

        @keyframes glowPulse {

            0%,
            100% {
                opacity: .6;
                transform: translateX(-50%) scale(1)
            }

            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.08)
            }
        }

        @keyframes btnShine {
            0% {
                left: -60%
            }

            30%,
            100% {
                left: 120%
            }
        }

        @keyframes specSlide {
            from {
                opacity: 0;
                transform: translateX(-16px)
            }

            to {
                opacity: 1;
                transform: translateX(0)
            }
        }

        @keyframes versionGlow {

            0%,
            100% {
                box-shadow: 0 0 0 rgba(0, 212, 255, 0)
            }

            50% {
                box-shadow: 0 0 12px rgba(0, 212, 255, .3)
            }
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        @keyframes priceReveal {
            from {
                opacity: 0;
                transform: translateY(8px) scale(.9);
                filter: blur(4px)
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0)
            }
        }

        @keyframes ctaPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(33, 102, 204, .4)
            }

            50% {
                box-shadow: 0 0 0 6px rgba(33, 102, 204, 0)
            }
        }

        @keyframes neonCtaPulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(0, 212, 255, .4)
            }

            50% {
                box-shadow: 0 0 0 8px rgba(0, 212, 255, 0)
            }
        }

        @keyframes dotFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: .7
            }

            50% {
                opacity: 1
            }

            100% {
                transform: translateY(-180px) scale(0);
                opacity: 0
            }
        }

        /* ─── v5 FUSION: New Keyframes ─── */
        @keyframes scanLine {
            0% {
                top: -2px
            }

            100% {
                top: 100%
            }
        }

        @keyframes holoShimmer {
            0% {
                background-position: -200% 0
            }

            100% {
                background-position: 200% 0
            }
        }

        @keyframes energyFill {
            from {
                width: 0;
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes urgencyPulse {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.05)
            }
        }

        @keyframes borderGlow {

            0%,
            100% {
                border-color: rgba(0, 212, 255, .15)
            }

            50% {
                border-color: rgba(0, 212, 255, .4)
            }
        }

        @keyframes dataStream {
            0% {
                background-position: 0 0
            }

            100% {
                background-position: 0 -200px
            }
        }

        /* ─── v5 FUSION: Cyber Grid Overlay (hover-only) ─── */
        .cyber-grid::after {
            content: '';
            position: absolute;
            inset: 0;
            background:
                linear-gradient(rgba(0, 212, 255, .03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, .03) 1px, transparent 1px);
            background-size: 24px 24px;
            pointer-events: none;
            z-index: 1;
            mask-image: linear-gradient(to bottom, transparent 10%, rgba(0, 0, 0, .3) 50%, transparent 90%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 10%, rgba(0, 0, 0, .3) 50%, transparent 90%);
            opacity: 0;
            transition: opacity .4s ease
        }

        .card:hover.cyber-grid::after {
            opacity: 1
        }

        /* ─── v5: Scanner Line (hover-only sweep) ─── */
        .scanner-line::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            box-shadow: 0 0 12px var(--accent), 0 0 24px rgba(0, 212, 255, .3);
            z-index: 10;
            opacity: 0;
            transition: opacity .3s ease;
            animation: none
        }

        .card:hover.scanner-line::before {
            opacity: .5;
            animation: scanLine 4s linear infinite
        }

        /* ─── v5: Holographic Shimmer (hover-only) ─── */
        .holo-shimmer::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(105deg,
                    transparent 30%,
                    rgba(0, 212, 255, .06) 38%,
                    rgba(168, 85, 247, .06) 42%,
                    rgba(0, 212, 255, .06) 46%,
                    transparent 54%);
            background-size: 200% 100%;
            animation: none;
            pointer-events: none;
            z-index: 5;
            border-radius: 18px;
            opacity: 0;
            transition: opacity .4s ease
        }

        .card:hover.holo-shimmer::after {
            opacity: 1;
            animation: holoShimmer 3s linear infinite
        }

        /* ─── v5: Lineup Badge ─── */
        .lineup-badge {
            position: absolute;
            top: 8px;
            left: 10px;
            transform: none;
            z-index: 20;
            font-size: 7px;
            font-weight: 900;
            letter-spacing: .1em;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 999px;
            backdrop-filter: blur(8px);
            white-space: nowrap;
            opacity: .86
        }

        .lineup-badge.se {
            background: rgba(33, 102, 204, .14);
            color: #9fc4ff;
            border: 1px solid rgba(33, 102, 204, .24)
        }

        .lineup-badge.pro {
            background: rgba(168, 85, 247, .14);
            color: #cfb2ff;
            border: 1px solid rgba(168, 85, 247, .24)
        }

        .card:hover .lineup-badge.pro {
            animation: borderGlow 2s ease-in-out infinite
        }

        .lineup-badge.max {
            background: linear-gradient(135deg, rgba(234, 179, 8, .15), rgba(249, 115, 22, .15));
            color: #ffd36b;
            border: 1px solid rgba(234, 179, 8, .25);
            text-shadow: 0 0 6px rgba(234, 179, 8, .2)
        }

        /* ─── v5: GPU Brand Badge ─── */
        .gpu-badge {
            font-size: 8px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 5px;
            letter-spacing: .04em;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap
        }

        .gpu-badge.nvidia {
            background: rgba(118, 185, 0, .15);
            color: #76b900;
            border: 1px solid rgba(118, 185, 0, .2)
        }

        .gpu-badge.amd {
            background: rgba(237, 28, 36, .15);
            color: #ff4444;
            border: 1px solid rgba(237, 28, 36, .2)
        }

        /* ─── v5: Urgency Pill ─── */
        .urgency-pill {
            font-size: 9px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(239, 68, 68, .15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, .2);
            text-transform: uppercase;
            letter-spacing: .04em;
            display: inline-block;
            transition: transform .2s
        }

        .card:hover .urgency-pill {
            animation: urgencyPulse 2s ease-in-out infinite
        }

        .urgency-pill.hot {
            background: linear-gradient(135deg, rgba(239, 68, 68, .2), rgba(249, 115, 22, .2));
            color: #fb923c;
            border-color: rgba(249, 115, 22, .3)
        }

        /* ─── v5: Social Proof ─── */
        .social-proof {
            font-size: 9px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 4px
        }

        .social-proof .dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--success);
            display: inline-block
        }

        /* ─── v5: Energy Meter (spec bars) ─── */
        .energy-meter {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .energy-row {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .energy-label {
            font-size: 8px;
            font-weight: 800;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .06em;
            width: 32px;
            flex-shrink: 0
        }

        .energy-bar {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, .06);
            border-radius: 3px;
            overflow: hidden;
            position: relative
        }

        .energy-fill {
            height: 100%;
            border-radius: 3px;
            animation: energyFill .8s ease both;
            position: relative
        }

        .energy-fill::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 60%, rgba(255, 255, 255, .3));
            border-radius: 3px
        }

        .energy-fill.gpu {
            background: linear-gradient(90deg, #76b900, #00d4ff)
        }

        .energy-fill.cpu {
            background: linear-gradient(90deg, var(--brand), var(--brand-light))
        }

        .energy-fill.ram {
            background: linear-gradient(90deg, #a855f7, #c084fc)
        }

        .energy-fill.storage {
            background: linear-gradient(90deg, #10b981, #34d399)
        }

        .energy-value {
            font-size: 8px;
            font-weight: 700;
            color: var(--text);
            width: 80px;
            flex-shrink: 0;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        /* ─── v5: Category Tag ─── */
        .category-tag {
            font-size: 8px;
            font-weight: 700;
            color: rgba(255, 255, 255, .4);
            text-transform: uppercase;
            letter-spacing: .06em;
            padding: 2px 6px;
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 4px;
            display: inline-block
        }

        .category-tag.light {
            color: rgba(0, 0, 0, .35);
            border-color: rgba(0, 0, 0, .08)
        }

        /* ─── v5: Data Stream BG (hover-only) ─── */
        .data-stream {
            position: absolute;
            inset: 0;
            opacity: 0;
            background: repeating-linear-gradient(0deg,
                    transparent 0px,
                    transparent 18px,
                    rgba(0, 212, 255, .5) 18px,
                    rgba(0, 212, 255, .5) 19px);
            animation: none;
            pointer-events: none;
            z-index: 0;
            transition: opacity .4s ease
        }

        .card:hover .data-stream {
            opacity: .03;
            animation: dataStream 8s linear infinite
        }

        .template-chips {
            display: flex;
            gap: 4px;
            flex-wrap: wrap
        }

        .chip {
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(255, 255, 255, .04);
            color: var(--muted);
            cursor: pointer;
            transition: all .15s;
            text-transform: uppercase;
            letter-spacing: .04em
        }

        .chip:hover {
            background: rgba(255, 255, 255, .08);
            color: var(--text)
        }

        .chip.active {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand)
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 4px 0
        }

        .collapsible-body {
            overflow: hidden;
            transition: max-height .3s
        }

        .collapsible-body.collapsed {
            max-height: 0 !important
        }

        .auto-bg-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px
        }

        .auto-bg-row label {
            font-size: 10px;
            color: var(--muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px
        }

        .auto-bg-row input[type=checkbox] {
            accent-color: var(--brand)
        }

        .preview {
            overflow: auto;
            padding: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-content: flex-start;
            background: radial-gradient(ellipse at 30% 20%, #111827, #070a0e 70%)
        }

        .preview-count {
            position: sticky;
            top: 0;
            width: 100%;
            padding: 8px 12px;
            background: rgba(7, 10, 14, .9);
            backdrop-filter: blur(8px);
            border-radius: 10px;
            border: 1px solid var(--stroke);
            font-size: 11px;
            color: var(--muted);
            z-index: 5;
            display: flex;
            gap: 12px;
            align-items: center
        }

        .preview-count strong {
            color: var(--text)
        }

        .card {
            width: 324px;
            aspect-ratio: 9/16;
            border-radius: 18px;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            transition: transform .3s cubic-bezier(.4, 0, .2, 1), box-shadow .3s;
            will-change: transform, opacity
        }

        .card:hover {
            transform: scale(1.02) translateY(-3px);
            box-shadow: 0 24px 48px rgba(0, 0, 0, .4)
        }

        .card .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 20;
            background: rgba(33, 102, 204, .85);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, .25);
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: .04em;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer
        }

        .card .remove-btn:hover {
            background: rgba(33, 102, 204, 1)
        }

        .card .bg-btn {
            right: 52px;
            background: rgba(16, 185, 129, .85);
            font-size: 8px;
            letter-spacing: .06em
        }

        .card .bg-btn:hover {
            background: rgba(16, 185, 129, 1)
        }

        .card .bg-btn.done {
            background: rgba(16, 185, 129, .3);
            pointer-events: none
        }

        .card .bg-btn.working {
            background: rgba(0, 212, 255, .6);
            pointer-events: none;
            animation: pulse 1s infinite
        }

        .bg-progress {
            font-size: 10px;
            font-weight: 700;
            color: var(--accent);
            padding: 4px 0;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .bg-progress .bar {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, .08);
            border-radius: 2px;
            overflow: hidden
        }

        .bg-progress .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--neon-purple));
            border-radius: 2px;
            transition: width .3s
        }

        .card .template-label {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 20;
            font-size: 8px;
            font-weight: 800;
            letter-spacing: .06em;
            text-transform: uppercase;
            padding: 3px 6px;
            border-radius: 4px;
            background: rgba(0, 0, 0, .5);
            display: none;
            color: rgba(255, 255, 255, .5);
            backdrop-filter: blur(4px)
        }

        .card .logo-watermark {
            height: 18px;
            width: auto;
            opacity: 1;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            display: block;
            object-fit: contain;
            object-position: center
        }

        /* ─── Per-card template switcher ─── */
        .tpl-switcher {
            position: absolute;
            top: 6px;
            left: 6px;
            z-index: 25;
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity .2s;
            pointer-events: none
        }

        .card:hover .tpl-switcher {
            opacity: 1;
            pointer-events: all
        }

        .tpl-switcher .ts-btn {
            font-size: 7px;
            font-weight: 800;
            letter-spacing: .04em;
            text-transform: uppercase;
            padding: 3px 6px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, .15);
            background: rgba(0, 0, 0, .6);
            color: rgba(255, 255, 255, .6);
            cursor: pointer;
            backdrop-filter: blur(8px);
            transition: all .15s
        }

        .tpl-switcher .ts-btn:hover {
            background: rgba(33, 102, 204, .8);
            color: #fff;
            border-color: rgba(33, 102, 204, .6)
        }

        .tpl-switcher .ts-btn.active {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand)
        }

        /* ─── Export format picker ─── */
        .export-picker {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px
        }

        .export-picker .ep-btn {
            font-size: 9px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--stroke);
            background: rgba(255, 255, 255, .04);
            color: var(--muted);
            cursor: pointer;
            transition: all .15s
        }

        .export-picker .ep-btn:hover {
            background: rgba(255, 255, 255, .08);
            color: var(--text)
        }

        .export-picker .ep-btn.active {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand)
        }

        /* ─── Sort indicator ─── */
        .sort-row {
            display: flex;
            gap: 4px;
            align-items: center
        }

        .sort-row select {
            background: rgba(255, 255, 255, .06);
            border: 1px solid var(--stroke);
            color: var(--text);
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600
        }

        .card .product-img {
            display: block;
            max-height: 90%;
            max-width: 82%;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 12px 32px rgba(0, 0, 0, .3));
            transition: transform .4s cubic-bezier(.4, 0, .2, 1), filter .4s;
            border-radius: 12px
        }

        .card .product-img.bg-removed {
            filter: drop-shadow(0 8px 24px rgba(0, 0, 0, .5)) drop-shadow(0 2px 8px rgba(0, 212, 255, .15));
            border-radius: 0
        }

        .card:hover .product-img {
            transform: scale(1.04);
            filter: drop-shadow(0 16px 40px rgba(0, 0, 0, .4))
        }

        /* .card .content — static, no entrance animation for clean export look */

        /* === HERO === */
        .tpl-hero {
            background:
                radial-gradient(circle at 16% 12%, rgba(47, 132, 255, .34) 0%, transparent 36%),
                radial-gradient(circle at 78% 14%, rgba(18, 92, 226, .26) 0%, transparent 32%),
                radial-gradient(circle at 52% 44%, rgba(255, 58, 74, .18) 0%, transparent 52%),
                radial-gradient(ellipse at 76% 84%, rgba(255, 78, 78, .2) 0%, transparent 42%),
                radial-gradient(ellipse at 22% 78%, rgba(20, 130, 255, .16) 0%, transparent 45%),
                linear-gradient(158deg, #031024 0%, #06162f 32%, #071a39 58%, #040f22 80%, #020816 100%);
            border: 1px solid rgba(74, 148, 255, .26);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .72), 0 0 90px rgba(37, 114, 255, .14), inset 0 0 120px rgba(255, 64, 64, .04);
            animation: heroBackdropFlow 14s ease-in-out infinite
        }

        .tpl-hero::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 18px;
            padding: 1px;
            background: linear-gradient(170deg, rgba(83, 156, 255, .5), rgba(255, 60, 80, .28) 32%, transparent 52%, rgba(58, 132, 255, .26));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            z-index: 1;
            animation: heroEdgeBreathe 8s ease-in-out infinite
        }

        /* Gaming mesh grid overlay */
        .tpl-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            background:
                linear-gradient(rgba(255, 40, 40, .03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 40, 40, .03) 1px, transparent 1px),
                /* Diagonal accent stripes */
                repeating-linear-gradient(45deg, transparent, transparent 60px, rgba(255, 50, 50, .02) 60px, rgba(255, 50, 50, .02) 61px);
            background-size: 30px 30px, 30px 30px, 86px 86px;
            pointer-events: none;
            z-index: 1;
            opacity: .52;
            animation: heroGridDrift 20s linear infinite
        }

        .tpl-hero:hover {
            box-shadow: 0 24px 64px rgba(44, 122, 255, .24), 0 20px 60px rgba(0, 0, 0, .7), 0 0 130px rgba(255, 64, 80, .14)
        }

        .tpl-hero .product-zone {
            position: absolute;
            top: 5%;
            left: 0;
            right: 0;
            height: 48%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px
        }

        .tpl-hero .product-zone .product-img {
            background: rgba(255, 255, 255, .96);
            border-radius: 14px;
            padding: 12px;
            max-height: 84%;
            max-width: 76%;
            object-fit: contain;
            border: 1.5px solid rgba(33, 102, 204, .15);
            box-shadow: 0 0 0 1px rgba(33, 102, 204, .06), 0 8px 24px rgba(0, 0, 0, .12)
        }

        .tpl-hero .product-zone .product-img.bg-removed {
            background: none;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none
        }

        .tpl-hero .product-img {
            filter: drop-shadow(0 16px 40px rgba(33, 102, 204, .2)) drop-shadow(0 4px 12px rgba(0, 0, 0, .4))
        }

        .tpl-hero .content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 18px 20px 22px;
            display: flex;
            flex-direction: column;
            gap: 7px;
            background: linear-gradient(to top, rgba(4, 7, 13, .98) 0%, rgba(8, 13, 24, .85) 60%, transparent 100%)
        }

        .tpl-hero .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .tpl-hero .logo-watermark {
            opacity: 1;
            height: 18px;
            background: rgba(255, 255, 255, .94);
            padding: 6px 12px;
            border-radius: 8px;
            backdrop-filter: blur(6px);
            display: block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .15)
        }

        .tpl-hero .stock-pill {
            background: rgba(16, 185, 129, .15);
            color: #34d399;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: .05em
        }

        .tpl-hero .hook {
            font-size: 22px;
            font-weight: 900;
            line-height: 1.05;
            letter-spacing: -.02em;
            text-transform: uppercase;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .tpl-hero .name {
            font-size: 11px;
            color: #8b9ab5;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tpl-hero .specs-line {
            font-size: 10px;
            color: #8fa8c7;
            margin-top: 2px
        }

        @keyframes heroBackdropFlow {

            0%,
            100% {
                background-position: 0% 50%, 100% 50%, 50% 50%, 70% 90%, 25% 75%, 50% 50%
            }

            50% {
                background-position: 6% 42%, 92% 56%, 54% 48%, 76% 82%, 18% 70%, 50% 50%
            }
        }

        @keyframes heroGridDrift {
            from {
                background-position: 0 0, 0 0, 0 0
            }

            to {
                background-position: 24px 24px, 24px 24px, 80px 80px
            }
        }

        @keyframes heroEdgeBreathe {

            0%,
            100% {
                opacity: .75
            }

            50% {
                opacity: 1
            }
        }

        .tpl-hero .price-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: 4px
        }

        .tpl-hero .price {
            font-size: 30px;
            font-weight: 900;
            letter-spacing: -.02em;
            background: linear-gradient(90deg, #fff 40%, var(--accent) 50%, #fff 60%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text
        }

        .tpl-hero:hover .price {
            animation: shimmer 4s linear infinite
        }

        .tpl-hero .cta-btn {
            background: var(--brand);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: .04em;
            text-transform: uppercase;
            padding: 10px 16px;
            text-align: center;
            transition: transform .2s, filter .2s, box-shadow .3s
        }

        .tpl-hero .cta-btn:hover {
            transform: scale(1.03);
            filter: brightness(1.15)
        }

        .tpl-hero:hover .cta-btn {
            animation: ctaPulse 2.5s ease infinite
        }

        /* ─── HERO VFX: Aurora Glow Halo ─── */
        .tpl-hero .hero-aurora {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 40%;
            border-radius: 50%;
            background: radial-gradient(ellipse, rgba(33, 102, 204, .2) 0%, rgba(0, 212, 255, .1) 30%, transparent 70%);
            filter: blur(30px);
            z-index: 1;
            opacity: .4;
            transition: opacity .5s .5s, transform .8s .5s
        }

        .tpl-hero:hover .hero-aurora {
            opacity: 1;
            transform: translateX(-50%) scale(1.15);
            animation: heroAuroraPulse 4s ease-in-out infinite
        }

        @keyframes heroAuroraPulse {

            0%,
            100% {
                opacity: .8;
                transform: translateX(-50%) scale(1.1)
            }

            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.2)
            }
        }

        /* ─── HERO VFX: Rotating Light Rays ─── */
        .tpl-hero .hero-rays {
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            z-index: 1;
            opacity: 0;
            transition: opacity .6s .5s;
            pointer-events: none;
            background:
                conic-gradient(from 0deg at 50% 35%,
                    transparent 0deg, rgba(33, 102, 204, .06) 15deg, transparent 30deg,
                    transparent 60deg, rgba(0, 212, 255, .04) 75deg, transparent 90deg,
                    transparent 120deg, rgba(33, 102, 204, .06) 135deg, transparent 150deg,
                    transparent 180deg, rgba(0, 212, 255, .04) 195deg, transparent 210deg,
                    transparent 240deg, rgba(33, 102, 204, .06) 255deg, transparent 270deg,
                    transparent 300deg, rgba(0, 212, 255, .04) 315deg, transparent 330deg,
                    transparent 360deg)
        }

        .tpl-hero:hover .hero-rays {
            opacity: 1;
            animation: heroRaysRotate 20s linear infinite
        }

        @keyframes heroRaysRotate {
            from {
                transform: rotate(0deg)
            }

            to {
                transform: rotate(360deg)
            }
        }

        /* ─── HERO VFX: Floating Sparks ─── */
        .tpl-hero .hero-particles {
            position: absolute;
            inset: 0;
            z-index: 2;
            overflow: hidden;
            opacity: 0;
            transition: opacity .5s .5s;
            pointer-events: none
        }

        .tpl-hero:hover .hero-particles {
            opacity: 1
        }

        .tpl-hero .h-spark {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            opacity: 0;
            animation: none
        }

        .tpl-hero:hover .h-spark {
            animation: heroSparkFloat linear infinite
        }

        @keyframes heroSparkFloat {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0
            }

            15% {
                opacity: 1
            }

            85% {
                opacity: .8
            }

            100% {
                transform: translateY(-120vh) scale(2);
                opacity: 0
            }
        }

        /* ─── HERO VFX: Edge Electric Glow ─── */
        .tpl-hero .hero-edge-glow {
            position: absolute;
            inset: -2px;
            border-radius: 20px;
            z-index: 0;
            opacity: 0;
            transition: opacity .4s .5s;
            pointer-events: none;
            background: conic-gradient(from 0deg,
                    rgba(33, 102, 204, .4), rgba(0, 212, 255, .6), rgba(168, 85, 247, .3),
                    rgba(0, 212, 255, .6), rgba(33, 102, 204, .4), rgba(168, 85, 247, .3),
                    rgba(0, 212, 255, .6), rgba(33, 102, 204, .4));
            background-size: 400% 400%;
            filter: blur(6px)
        }

        .tpl-hero:hover .hero-edge-glow {
            opacity: 1;
            animation: heroEdgeSpin 6s linear infinite
        }

        @keyframes heroEdgeSpin {
            0% {
                background-position: 0% 0%
            }

            100% {
                background-position: 400% 400%
            }
        }

        /* ─── HERO VFX: Lens Flare ─── */
        .tpl-hero .hero-flare {
            position: absolute;
            top: 12%;
            left: 55%;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, .15) 0%, rgba(0, 212, 255, .08) 30%, transparent 60%);
            z-index: 3;
            opacity: 0;
            transition: opacity .6s .7s;
            pointer-events: none;
            filter: blur(8px)
        }

        .tpl-hero:hover .hero-flare {
            opacity: 1;
            animation: heroFlareShift 5s ease-in-out infinite
        }

        @keyframes heroFlareShift {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: .7
            }

            30% {
                transform: translate(-20px, 10px) scale(1.3);
                opacity: 1
            }

            70% {
                transform: translate(15px, -5px) scale(.9);
                opacity: .5
            }
        }

        /* ─── HERO VFX: Product Spotlight Ring ─── */
        .tpl-hero .hero-spotlight {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 55%;
            height: 38%;
            border-radius: 50%;
            border: 1.5px solid rgba(33, 102, 204, .08);
            z-index: 2;
            opacity: 0;
            transition: opacity .5s .5s, border-color .5s;
            pointer-events: none
        }

        .tpl-hero:hover .hero-spotlight {
            opacity: 1;
            border-color: rgba(0, 212, 255, .2);
            animation: heroSpotlightPulse 3s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(0, 212, 255, .1), inset 0 0 40px rgba(33, 102, 204, .05)
        }

        @keyframes heroSpotlightPulse {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
                opacity: .7
            }

            50% {
                transform: translateX(-50%) scale(1.06);
                opacity: 1
            }
        }

        /* ─── HERO VFX: Product hover lift ─── */
        .tpl-hero .product-zone .product-img {
            transition: transform .6s cubic-bezier(.22, 1, .36, 1), filter .6s
        }

        .tpl-hero:hover .product-zone .product-img {
            transform: translateY(-6px) scale(1.03);
            filter: drop-shadow(0 20px 50px rgba(33, 102, 204, .35)) drop-shadow(0 6px 16px rgba(0, 0, 0, .5))
        }

        .tpl-hero:hover .product-zone .product-img.bg-removed {
            filter: drop-shadow(0 0 60px rgba(0, 212, 255, .35)) drop-shadow(0 0 120px rgba(33, 102, 204, .15)) drop-shadow(0 30px 60px rgba(0, 0, 0, .8))
        }

        /* ─── HERO VFX: Bottom content glow bar ─── */
        .tpl-hero .hero-glow-bar {
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, .5), rgba(33, 102, 204, .6), rgba(0, 212, 255, .5), transparent);
            z-index: 11;
            opacity: 0;
            transition: opacity .4s .5s;
            filter: blur(1px)
        }

        .tpl-hero:hover .hero-glow-bar {
            opacity: 1
        }

        /* === SPLIT === */
        .tpl-split {
            background: #f5f7fa;
            border: 1px solid rgba(0, 0, 0, .06);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .15)
        }

        .tpl-split .product-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 52%;
            background: linear-gradient(160deg, #edf0f5, #f8f9fb);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 18px
        }

        .tpl-split .product-img {
            max-height: 86%;
            max-width: 78%;
            object-fit: contain;
            filter: drop-shadow(0 8px 24px rgba(0, 0, 0, .12));
            border-radius: 12px;
            background: #fff;
            padding: 10px;
            border: 1.5px solid rgba(33, 102, 204, .10);
            box-shadow: 0 0 0 1px rgba(33, 102, 204, .04), 0 4px 16px rgba(0, 0, 0, .05)
        }

        .tpl-split .product-img.bg-removed {
            background: none;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none
        }

        .tpl-split .content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            padding: 16px 20px 22px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: #fff
        }

        .tpl-split .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .tpl-split .logo-watermark {
            opacity: 1;
            height: 18px
        }

        .tpl-split .stock-pill {
            background: #111827;
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 999px;
            text-transform: uppercase
        }

        .tpl-split .divider {
            width: 40px;
            height: 3px;
            background: var(--brand);
            border-radius: 2px
        }

        .tpl-split .hook {
            font-size: 20px;
            font-weight: 900;
            line-height: 1.05;
            color: #111827;
            text-transform: uppercase;
            letter-spacing: -.01em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .tpl-split .name {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tpl-split .specs-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 2px
        }

        .tpl-split .spec-tag {
            font-size: 9px;
            font-weight: 700;
            color: #4b5563;
            background: #f3f4f6;
            padding: 3px 8px;
            border-radius: 6px;
            border: 1px solid #e5e7eb
        }

        .tpl-split .price-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto
        }

        .tpl-split .price {
            font-size: 28px;
            font-weight: 900;
            color: #111827;
            letter-spacing: -.02em
        }

        .tpl-split .cta-btn {
            background: #111827;
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: .04em;
            padding: 10px 16px;
            text-align: center;
            transition: transform .2s, box-shadow .2s
        }

        .tpl-split .cta-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 24px rgba(0, 0, 0, .15)
        }

        /* === MINIMAL === */
        .tpl-minimal {
            background: #f5f7fa;
            border: 1px solid rgba(0, 0, 0, .06);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .15)
        }

        .tpl-minimal .product-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 55%;
            background: linear-gradient(180deg, #ffffff, #f0f2f6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 18px
        }

        .tpl-minimal .product-img {
            max-height: 86%;
            max-width: 78%;
            object-fit: contain;
            filter: drop-shadow(0 12px 32px rgba(0, 0, 0, .12));
            border-radius: 12px;
            background: #fff;
            padding: 10px;
            border: 1.5px solid rgba(33, 102, 204, .08);
            box-shadow: 0 0 0 1px rgba(33, 102, 204, .04), 0 4px 16px rgba(0, 0, 0, .04)
        }

        .tpl-minimal .product-img.bg-removed {
            background: none;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none
        }

        .tpl-minimal .content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 45%;
            padding: 18px 20px 22px;
            display: flex;
            flex-direction: column;
            gap: 5px
        }

        .tpl-minimal .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .tpl-minimal .logo-watermark {
            opacity: 1;
            height: 18px
        }

        .tpl-minimal .stock-tag {
            background: var(--success);
            color: #fff;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 999px;
            text-transform: uppercase
        }

        .tpl-minimal .claim {
            font-size: 10px;
            font-weight: 700;
            color: var(--brand);
            text-transform: uppercase;
            letter-spacing: .06em
        }

        .tpl-minimal .hook {
            font-size: 20px;
            font-weight: 900;
            line-height: 1.05;
            color: #111827;
            text-transform: uppercase;
            letter-spacing: -.01em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .tpl-minimal .name {
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tpl-minimal .specs-line {
            font-size: 10px;
            color: #9ca3af
        }

        .tpl-minimal .price-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto
        }

        .tpl-minimal .price {
            font-size: 28px;
            font-weight: 900;
            color: #111827;
            letter-spacing: -.02em
        }

        .tpl-minimal .cta-btn {
            background: #111827;
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            padding: 10px 14px;
            text-transform: uppercase;
            letter-spacing: .04em;
            transition: transform .2s
        }

        .tpl-minimal .cta-btn:hover {
            transform: scale(1.03)
        }

        /* === NEON === */
        .tpl-neon {
            background:
                radial-gradient(circle at 18% 15%, rgba(0, 228, 255, .22) 0%, transparent 34%),
                radial-gradient(circle at 82% 18%, rgba(255, 60, 86, .22) 0%, transparent 32%),
                radial-gradient(circle at 50% 50%, rgba(42, 122, 255, .12) 0%, transparent 52%),
                radial-gradient(circle at 30% 84%, rgba(90, 168, 255, .16) 0%, transparent 38%),
                radial-gradient(circle at 74% 76%, rgba(255, 72, 96, .14) 0%, transparent 42%),
                linear-gradient(164deg, #040d1c 0%, #061428 32%, #07152a 62%, #030910 100%);
            border: 1px solid rgba(82, 170, 255, .26);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .72), 0 0 100px rgba(32, 126, 255, .13), inset 0 0 100px rgba(255, 64, 96, .04)
        }

        /* Neon hex grid overlay */
        .tpl-neon::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            background:
                linear-gradient(rgba(0, 212, 255, .04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, .04) 1px, transparent 1px),
                repeating-linear-gradient(-45deg, transparent, transparent 80px, rgba(168, 85, 247, .02) 80px, rgba(168, 85, 247, .02) 81px);
            background-size: 24px 24px, 24px 24px, 113px 113px;
            pointer-events: none;
            z-index: 1;
            opacity: .6
        }

        .tpl-neon .glow-ring {
            position: absolute;
            top: 8%;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 212, 255, .1), rgba(168, 85, 247, .06), transparent 70%);
            pointer-events: none;
            animation: none;
            opacity: .3;
            transition: opacity .5s .5s;
            opacity: .7
        }

        .tpl-neon:hover .glow-ring {
            animation: glowPulse 3s ease-in-out infinite
        }

        .tpl-neon .particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
            opacity: 0;
            transition: opacity .5s .5s
        }

        .tpl-neon:hover .particles {
            opacity: 1
        }

        .tpl-neon .particle {
            position: absolute;
            bottom: -10px;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--accent);
            animation: dotFloat linear infinite;
            opacity: 0
        }

        .tpl-neon .product-zone {
            position: absolute;
            top: 5%;
            left: 0;
            right: 0;
            height: 46%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            padding: 10px 18px
        }

        .tpl-neon .product-img {
            background: rgba(255, 255, 255, .94);
            border-radius: 14px;
            padding: 12px;
            max-height: 82%;
            max-width: 74%;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, .1)) drop-shadow(0 12px 32px rgba(0, 0, 0, .5));
            transition: filter .4s ease, transform .4s ease;
            border: 1.5px solid rgba(0, 212, 255, .15);
            box-shadow: 0 0 0 1px rgba(0, 212, 255, .06), 0 8px 24px rgba(0, 0, 0, .15)
        }

        .tpl-neon .product-img.bg-removed {
            background: none;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none
        }

        .tpl-neon:hover .product-img {
            filter: drop-shadow(0 0 40px rgba(0, 212, 255, .25)) drop-shadow(0 16px 40px rgba(0, 0, 0, .5));
            animation: float 4s ease-in-out infinite
        }

        .tpl-neon .content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px 22px;
            display: flex;
            flex-direction: column;
            gap: 7px;
            background: linear-gradient(to top, rgba(5, 8, 14, .98) 0%, rgba(5, 8, 14, .8) 60%, transparent 100%);
            z-index: 3
        }

        .tpl-neon .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .tpl-neon .logo-watermark {
            opacity: 1;
            height: 18px;
            background: rgba(255, 255, 255, .94);
            padding: 6px 12px;
            border-radius: 8px;
            backdrop-filter: blur(6px);
            box-shadow: 0 0 16px rgba(0, 212, 255, .25), 0 2px 8px rgba(0, 0, 0, .2);
            display: block
        }

        .tpl-neon .stock-pill {
            background: rgba(0, 212, 255, .12);
            color: var(--accent);
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 999px;
            text-transform: uppercase
        }

        .tpl-neon .claim {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .08em;
            background: linear-gradient(90deg, var(--accent), var(--neon-purple), var(--accent));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text
        }

        .tpl-neon:hover .claim {
            animation: shimmer 3s linear infinite
        }

        .tpl-neon .hook {
            font-size: 22px;
            font-weight: 900;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: -.02em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .tpl-neon .name {
            font-size: 11px;
            color: #6b7a92;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tpl-neon .specs-line {
            font-size: 10px;
            color: #8ca4c2
        }

        .tpl-neon .price {
            font-size: 32px;
            font-weight: 900;
            letter-spacing: -.02em;
            background: linear-gradient(90deg, #fff 30%, var(--accent) 50%, #fff 70%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text
        }

        .tpl-neon:hover .price {
            animation: shimmer 3s linear infinite
        }

        .tpl-neon .cta-btn {
            background: linear-gradient(135deg, var(--accent), var(--neon-purple));
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: .04em;
            padding: 10px 16px;
            text-align: center;
            transition: transform .2s, filter .2s, box-shadow .3s
        }

        .tpl-neon .cta-btn:hover {
            transform: scale(1.03);
            filter: brightness(1.15)
        }

        .tpl-neon:hover .cta-btn {
            animation: neonCtaPulse 2.5s ease infinite
        }

        /* === SPECS === */
        .tpl-specs {
            background:
                radial-gradient(circle at 20% 12%, rgba(83, 156, 255, .14) 0%, transparent 35%),
                radial-gradient(circle at 78% 20%, rgba(120, 151, 189, .12) 0%, transparent 32%),
                radial-gradient(circle at 52% 62%, rgba(74, 110, 153, .1) 0%, transparent 46%),
                radial-gradient(circle at 18% 88%, rgba(56, 89, 125, .1) 0%, transparent 36%),
                radial-gradient(circle at 84% 82%, rgba(86, 125, 170, .08) 0%, transparent 40%),
                linear-gradient(166deg, #0b1119 0%, #0a1017 35%, #0d141d 62%, #090d13 100%);
            border: 1px solid rgba(126, 153, 188, .2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, .62), 0 0 60px rgba(90, 128, 172, .06)
        }

        /* Tactical grid overlay */
        .tpl-specs::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            background:
                linear-gradient(rgba(33, 102, 204, .03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(33, 102, 204, .03) 1px, transparent 1px),
                repeating-linear-gradient(30deg, transparent, transparent 100px, rgba(16, 185, 129, .015) 100px, rgba(16, 185, 129, .015) 101px);
            background-size: 20px 20px, 20px 20px, 141px 141px;
            pointer-events: none;
            z-index: 1;
            opacity: .5
        }

        .tpl-specs .product-zone {
            position: absolute;
            top: 1%;
            left: 0;
            right: 0;
            height: 44%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px
        }

        .tpl-specs .product-img {
            background: rgba(255, 255, 255, .96);
            border-radius: 12px;
            padding: 10px;
            max-height: 88%;
            max-width: 72%;
            object-fit: contain;
            filter: drop-shadow(0 8px 24px rgba(0, 0, 0, .4));
            border: 1.5px solid rgba(33, 102, 204, .14);
            box-shadow: 0 0 0 1px rgba(33, 102, 204, .05), 0 6px 20px rgba(0, 0, 0, .12)
        }

        .tpl-specs .product-img.bg-removed {
            background: none;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none
        }

        .tpl-specs .content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 58%;
            padding: 12px 18px 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: linear-gradient(to top, #0b0f1a 0%, #0b0f1a 75%, rgba(11, 15, 26, .85) 90%, transparent 100%)
        }

        .tpl-specs .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .tpl-specs .logo-watermark {
            opacity: 1;
            height: 18px;
            background: rgba(255, 255, 255, .94);
            padding: 6px 12px;
            border-radius: 8px;
            backdrop-filter: blur(6px);
            display: block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .15)
        }

        .tpl-specs .stock-pill {
            background: rgba(16, 185, 129, .15);
            color: #34d399;
            font-size: 9px;
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 999px;
            text-transform: uppercase
        }

        .tpl-specs .hook {
            font-size: 16px;
            font-weight: 900;
            line-height: 1.1;
            text-transform: uppercase;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .tpl-specs .name {
            font-size: 10px;
            color: #6b7a92;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tpl-specs .specs-table {
            display: flex;
            flex-direction: column;
            gap: 5px
        }

        .tpl-specs .spec-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 12px;
            background: rgba(255, 255, 255, .02);
            border: 1px solid rgba(180, 200, 224, .12);
            border-radius: 10px;
            transition: background .2s, border-color .2s
        }

        .tpl-specs .spec-row:hover {
            background: rgba(84, 122, 168, .1);
            border-color: rgba(130, 167, 212, .28)
        }

        .tpl-specs .spec-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: rgba(96, 128, 170, .16);
            border: 1px solid rgba(120, 154, 200, .24);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 900;
            letter-spacing: .03em;
            color: #d7e5f8;
            flex-shrink: 0;
            text-transform: uppercase;
            font-family: 'Inter', system-ui, sans-serif
        }

        .tpl-specs .spec-label {
            font-size: 8px;
            color: #8fa3bd;
            text-transform: uppercase;
            letter-spacing: .06em;
            font-weight: 700;
            line-height: 1
        }

        .tpl-specs .spec-value {
            font-size: 11px;
            font-weight: 700;
            color: #eef3fb;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px
        }

        .tpl-specs .price-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: auto
        }

        .tpl-specs .price {
            font-size: 28px;
            font-weight: 900;
            letter-spacing: -.02em
        }

        .tpl-specs .cta-btn {
            background: var(--brand);
            color: #fff;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            padding: 10px 14px;
            text-transform: uppercase;
            letter-spacing: .04em;
            transition: transform .2s, box-shadow .3s
        }

        .tpl-specs .cta-btn:hover {
            transform: scale(1.03)
        }

        .tpl-specs:hover .cta-btn {
            animation: ctaPulse 2.5s ease infinite
        }

        /* ═══════════════════════════════════════════════════════
           FORMAT-SPECIFIC LAYOUTS — 1:1, FB Banner, 16:9
           ═══════════════════════════════════════════════════════ */

        /* ─── 1:1 Square (1080×1080) ─── */
        .card.fmt-square {
            aspect-ratio: 1/1
        }

        .card.fmt-square .product-zone {
            height: 42% !important;
            top: 1% !important
        }

        .card.fmt-square .content {
            height: auto !important;
            max-height: 56% !important;
            padding-bottom: 14px !important;
            padding-top: 10px !important
        }

        .card.fmt-square .hook {
            font-size: 16px !important;
            -webkit-line-clamp: 2 !important;
            line-clamp: 2 !important
        }

        .card.fmt-square .price {
            font-size: 28px !important
        }

        .card.fmt-square .product-name,
        .card.fmt-square .name {
            font-size: 10px !important
        }

        .card.fmt-square .specs-line {
            font-size: 9px !important
        }

        .card.fmt-square .cta-btn {
            font-size: 10px !important;
            padding: 8px 14px !important
        }

        .card.fmt-square .logo-watermark {
            height: 14px !important;
            padding: 4px 8px !important
        }

        .card.fmt-square .product-img {
            max-height: 85% !important;
            max-width: 70% !important
        }

        /* Cinema letterbox bars thinner in square */
        .card.fmt-square .cinema-bar {
            height: 5% !important
        }

        /* ─── FB Banner (1200×628) — Wide landscape ─── */
        .card.fmt-fb {
            aspect-ratio: 1200/628;
            width: 440px
        }

        .card.fmt-fb .product-zone {
            top: 0 !important;
            left: 0 !important;
            right: auto !important;
            width: 40% !important;
            height: 100% !important;
            padding: 8px !important
        }

        .card.fmt-fb .content {
            top: 0 !important;
            bottom: 0 !important;
            left: 40% !important;
            right: 0 !important;
            width: 60% !important;
            height: 100% !important;
            padding: 10px 14px !important;
            justify-content: center !important;
            gap: 4px !important
        }

        /* Dark templates gradient horizontal in FB */
        .tpl-hero.fmt-fb .content,
        .tpl-neon.fmt-fb .content,
        .tpl-specs.fmt-fb .content,
        .tpl-cinema.fmt-fb .content {
            background: linear-gradient(to left, rgba(4, 7, 13, .96) 0%, rgba(4, 7, 13, .85) 60%, transparent 100%) !important
        }

        /* Light templates gradient horizontal in FB */
        .tpl-split.fmt-fb .content,
        .tpl-minimal.fmt-fb .content {
            background: linear-gradient(to left, #fff 0%, rgba(255, 255, 255, .97) 60%, rgba(255, 255, 255, .7) 100%) !important
        }

        .card.fmt-fb .hook {
            font-size: 13px !important;
            -webkit-line-clamp: 2 !important;
            line-clamp: 2 !important
        }

        .card.fmt-fb .price {
            font-size: 22px !important
        }

        .card.fmt-fb .product-name,
        .card.fmt-fb .name {
            font-size: 9px !important
        }

        .card.fmt-fb .specs-line {
            font-size: 8px !important
        }

        .card.fmt-fb .cta-btn {
            font-size: 9px !important;
            padding: 6px 12px !important
        }

        .card.fmt-fb .logo-watermark {
            height: 12px !important;
            padding: 3px 7px !important
        }

        .card.fmt-fb .product-img {
            max-height: 80% !important;
            max-width: 88% !important
        }

        .card.fmt-fb .cinema-bar {
            height: 6% !important
        }

        .card.fmt-fb .logo-row {
            flex-wrap: wrap !important;
            gap: 3px !important
        }

        /* Hero VFX layers reposition for wide */
        .tpl-hero.fmt-fb .hero-aurora,
        .tpl-hero.fmt-fb .hero-rays,
        .tpl-hero.fmt-fb .hero-spotlight,
        .tpl-hero.fmt-fb .hero-flare {
            left: 20% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important
        }

        .tpl-hero.fmt-fb .lineup-badge,
        .tpl-neon.fmt-fb .lineup-badge {
            top: 6px !important;
            left: 8px !important;
            font-size: 6.5px !important;
            padding: 2px 7px !important;
            opacity: .78 !important
        }

        /* Neon glow ring reposition */
        .tpl-neon.fmt-fb .glow-ring {
            left: 20% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 35% !important;
            height: 70% !important
        }

        /* Cinema glow reposition */
        .tpl-cinema.fmt-fb .cinema-glow {
            left: 20% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 35% !important
        }

        /* ─── 16:9 Wide (1920×1080) ─── */
        .card.fmt-wide {
            aspect-ratio: 16/9;
            width: 460px
        }

        .card.fmt-wide .product-zone {
            top: 0 !important;
            left: 0 !important;
            right: auto !important;
            width: 42% !important;
            height: 100% !important;
            padding: 10px !important
        }

        .card.fmt-wide .content {
            top: 0 !important;
            bottom: 0 !important;
            left: 42% !important;
            right: 0 !important;
            width: 58% !important;
            height: 100% !important;
            padding: 12px 16px !important;
            justify-content: center !important;
            gap: 5px !important
        }

        /* Dark templates gradient horizontal in 16:9 */
        .tpl-hero.fmt-wide .content,
        .tpl-neon.fmt-wide .content,
        .tpl-specs.fmt-wide .content,
        .tpl-cinema.fmt-wide .content {
            background: linear-gradient(to left, rgba(4, 7, 13, .96) 0%, rgba(4, 7, 13, .85) 60%, transparent 100%) !important
        }

        /* Light templates gradient horizontal in 16:9 */
        .tpl-split.fmt-wide .content,
        .tpl-minimal.fmt-wide .content {
            background: linear-gradient(to left, #fff 0%, rgba(255, 255, 255, .97) 60%, rgba(255, 255, 255, .7) 100%) !important
        }

        .card.fmt-wide .hook {
            font-size: 15px !important;
            -webkit-line-clamp: 2 !important;
            line-clamp: 2 !important
        }

        .card.fmt-wide .price {
            font-size: 26px !important
        }

        .card.fmt-wide .product-name,
        .card.fmt-wide .name {
            font-size: 10px !important
        }

        .card.fmt-wide .specs-line {
            font-size: 9px !important
        }

        .card.fmt-wide .cta-btn {
            font-size: 10px !important;
            padding: 7px 14px !important
        }

        .card.fmt-wide .logo-watermark {
            height: 14px !important;
            padding: 4px 8px !important
        }

        .card.fmt-wide .product-img {
            max-height: 82% !important;
            max-width: 86% !important
        }

        .card.fmt-wide .cinema-bar {
            height: 7% !important
        }

        .card.fmt-wide .logo-row {
            flex-wrap: wrap !important;
            gap: 4px !important
        }

        /* Hero VFX layers reposition for 16:9 */
        .tpl-hero.fmt-wide .hero-aurora,
        .tpl-hero.fmt-wide .hero-rays,
        .tpl-hero.fmt-wide .hero-spotlight,
        .tpl-hero.fmt-wide .hero-flare {
            left: 21% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important
        }

        .tpl-hero.fmt-wide .lineup-badge,
        .tpl-neon.fmt-wide .lineup-badge {
            top: 7px !important;
            left: 9px !important;
            font-size: 6.5px !important;
            padding: 2px 7px !important;
            opacity: .78 !important
        }

        .tpl-neon.fmt-wide .glow-ring {
            left: 21% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 38% !important;
            height: 70% !important
        }

        .tpl-cinema.fmt-wide .cinema-glow {
            left: 21% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 38% !important
        }

        /* ═══════════════════════════════════════════════════════
           VIDEO EXPORT MODAL
           ═══════════════════════════════════════════════════════ */

        .vex-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(0, 0, 0, .85);
            backdrop-filter: blur(24px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px
        }

        .vex-overlay.open {
            display: flex
        }

        .vex-panel {
            background: linear-gradient(160deg, #12151e 0%, #0c0f17 100%);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 20px;
            width: 680px;
            max-width: 96vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 40px 120px rgba(0, 0, 0, .8), 0 0 0 1px rgba(255, 255, 255, .04);
            display: flex;
            flex-direction: column
        }

        .vex-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 22px;
            border-bottom: 1px solid rgba(255, 255, 255, .06)
        }

        .vex-title {
            font-size: 16px;
            font-weight: 800;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .vex-close {
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .1);
            color: #fff;
            font-size: 18px;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s
        }

        .vex-close:hover {
            background: rgba(255, 255, 255, .12)
        }

        .vex-body {
            padding: 18px 22px;
            display: flex;
            gap: 20px
        }

        .vex-preview {
            flex: 0 0 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .4);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .06);
            min-height: 180px;
            overflow: hidden;
            position: relative
        }

        .vex-preview .card {
            transform: scale(0.42);
            transform-origin: center center;
            pointer-events: none
        }

        .vex-preview-empty {
            color: var(--muted);
            font-size: 11px;
            text-align: center;
            padding: 20px
        }

        .vex-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 14px
        }

        .vex-field-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 4px
        }

        .vex-btn-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap
        }

        .vex-opt {
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .1);
            background: rgba(255, 255, 255, .04);
            color: var(--muted);
            cursor: pointer;
            transition: all .15s;
            font-family: inherit
        }

        .vex-opt:hover {
            background: rgba(255, 255, 255, .08);
            color: var(--text)
        }

        .vex-opt.active {
            background: var(--brand);
            color: #fff;
            border-color: var(--brand)
        }

        .vex-render-btn {
            margin-top: 6px;
            background: linear-gradient(135deg, var(--accent), var(--neon-purple));
            color: #fff;
            font-size: 13px;
            font-weight: 800;
            letter-spacing: .02em;
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all .2s;
            font-family: inherit;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px
        }

        .vex-render-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(0, 212, 255, .3)
        }

        .vex-render-btn:disabled {
            opacity: .5;
            pointer-events: none
        }

        .vex-progress {
            margin-top: 8px;
            display: none
        }

        .vex-progress.active {
            display: block
        }

        .vex-progress-bar {
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, .06);
            overflow: hidden
        }

        .vex-progress-fill {
            height: 100%;
            width: 0%;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--accent), var(--neon-purple));
            transition: width .3s
        }

        .vex-progress-text {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
            text-align: center
        }

        .vex-footer {
            padding: 12px 22px 18px;
            border-top: 1px solid rgba(255, 255, 255, .06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px
        }

        .vex-info {
            font-size: 10px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px
        }

        .vex-info-val {
            color: var(--accent);
            font-weight: 700
        }

        /* === v5.3 PRO: Card Selection === */
        .card {
            cursor: pointer
        }

        .card.selected {
            outline: 3px solid var(--accent);
            outline-offset: -3px;
            box-shadow: 0 0 24px rgba(0, 212, 255, .3), 0 20px 60px rgba(0, 0, 0, .6)
        }

        /* Force hover states when recording video */
        .card.recording-active .hero-aurora,
        .card.recording-active .hero-rays,
        .card.recording-active .hero-particles,
        .card.recording-active .hero-edge-glow,
        .card.recording-active .hero-flare,
        .card.recording-active .hero-spotlight,
        .card.recording-active .hero-glow-bar {
            opacity: 1 !important
        }

        .card.recording-active .glow-ring {
            opacity: .7 !important;
            animation: glowPulse 3s ease-in-out infinite !important
        }

        .card.recording-active .particles {
            opacity: 1 !important
        }

        .card.recording-active .cinema-bg {
            animation: cinemaBgPulse 8s ease-in-out infinite !important
        }

        .card.recording-active .cinema-particles {
            opacity: 1 !important
        }

        .card.recording-active .cinema-sweep {
            opacity: 1 !important;
            animation: cinemaSweep 6s ease-in-out infinite !important
        }

        .card.recording-active .cinema-glow {
            opacity: .6 !important;
            animation: cinemaGlow 4s ease-in-out infinite !important
        }

        .card.recording-active .product-img {
            animation: cinemaProductFloat 5s ease-in-out infinite !important
        }

        .card.recording-active .hook {
            animation: shimmer 4s linear infinite !important
        }

        .card.recording-active .cta-btn {
            animation: cinemaCtaShift 5s ease infinite !important
        }

        .card .select-check {
            position: absolute;
            bottom: 8px;
            right: 8px;
            z-index: 25;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, .2);
            background: rgba(0, 0, 0, .4);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: transparent;
            transition: all .2s;
            pointer-events: none
        }

        .card.selected .select-check {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
            box-shadow: 0 0 12px rgba(0, 212, 255, .5)
        }

        /* ═══════════════════════════════════════════════════════
           CINEMA TEMPLATE — PRO VFX / VIDEO-READY ANIMATIONS
           ═══════════════════════════════════════════════════════ */

        .tpl-cinema {
            background: #000;
            overflow: hidden;
            border: none;
            box-shadow: 0 0 80px rgba(0, 0, 0, .8)
        }

        /* Cinematic letterbox bars */
        .tpl-cinema .cinema-bar {
            position: absolute;
            left: 0;
            right: 0;
            height: 8%;
            background: #000;
            z-index: 20
        }

        .tpl-cinema .cinema-bar.top {
            top: 0
        }

        .tpl-cinema .cinema-bar.bottom {
            bottom: 0
        }

        /* Animated gradient background */
        .tpl-cinema .cinema-bg {
            position: absolute;
            inset: 0;
            background:
                /* Hot red/crimson cinema drama */
                radial-gradient(circle at 20% 30%, rgba(200, 0, 50, .3) 0%, transparent 40%),
                radial-gradient(circle at 80% 40%, rgba(150, 0, 200, .25) 0%, transparent 35%),
                radial-gradient(circle at 50% 80%, rgba(255, 40, 80, .15) 0%, transparent 45%),
                radial-gradient(circle at 40% 10%, rgba(100, 0, 255, .12) 0%, transparent 30%),
                radial-gradient(ellipse at 70% 90%, rgba(255, 100, 0, .1) 0%, transparent 35%),
                linear-gradient(180deg, #080210 0%, #0a0418 50%, #050108 100%);
            z-index: 1;
            animation: none;
            transition: opacity .5s .5s
        }

        .tpl-cinema:hover .cinema-bg {
            animation: cinemaBgPulse 8s ease-in-out infinite
        }

        @keyframes cinemaBgPulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .7
            }
        }

        /* Floating particles */
        .tpl-cinema .cinema-particles {
            position: absolute;
            inset: 0;
            z-index: 2;
            overflow: hidden;
            opacity: 0;
            transition: opacity .5s .5s
        }

        .tpl-cinema:hover .cinema-particles {
            opacity: 1
        }

        .tpl-cinema .c-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: rgba(0, 212, 255, .6);
            animation: cinemaFloat linear infinite;
            opacity: 0
        }

        @keyframes cinemaFloat {
            0% {
                transform: translateY(100%) scale(0);
                opacity: 0
            }

            10% {
                opacity: 1
            }

            90% {
                opacity: 1
            }

            100% {
                transform: translateY(-100vh) scale(1.5);
                opacity: 0
            }
        }

        /* Light sweep across the card */
        .tpl-cinema .cinema-sweep {
            position: absolute;
            inset: 0;
            z-index: 3;
            background: linear-gradient(105deg, transparent 40%, rgba(255, 255, 255, .06) 45%, rgba(255, 255, 255, .12) 50%, rgba(255, 255, 255, .06) 55%, transparent 60%);
            background-size: 300% 100%;
            animation: none;
            opacity: 0;
            transition: opacity .5s .5s
        }

        .tpl-cinema:hover .cinema-sweep {
            opacity: 1;
            animation: cinemaSweep 6s ease-in-out infinite
        }

        @keyframes cinemaSweep {

            0%,
            100% {
                background-position: 200% 0
            }

            50% {
                background-position: -100% 0
            }
        }

        /* Scan lines overlay */
        .tpl-cinema .cinema-scanlines {
            position: absolute;
            inset: 0;
            z-index: 4;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, .08) 2px, rgba(0, 0, 0, .08) 4px);
            pointer-events: none
        }

        /* Product zone — center hero spotlight */
        .tpl-cinema .product-zone {
            position: absolute;
            top: 8%;
            left: 0;
            right: 0;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            z-index: 10
        }

        .tpl-cinema .product-img {
            max-height: 90%;
            max-width: 80%;
            object-fit: contain;
            filter: drop-shadow(0 0 40px rgba(0, 212, 255, .3)) drop-shadow(0 20px 60px rgba(0, 0, 0, .8));
            animation: none;
            border: none;
            background: none;
            padding: 0;
            transition: transform .6s cubic-bezier(.22, 1, .36, 1), filter .6s
        }

        .tpl-cinema:hover .product-img {
            animation: cinemaProductFloat 5s ease-in-out infinite
        }

        @keyframes cinemaProductFloat {

            0%,
            100% {
                transform: translateY(0) scale(1)
            }

            50% {
                transform: translateY(-8px) scale(1.02)
            }
        }

        .tpl-cinema .product-img.bg-removed {
            filter: drop-shadow(0 0 60px rgba(0, 212, 255, .4)) drop-shadow(0 0 120px rgba(168, 85, 247, .2)) drop-shadow(0 30px 80px rgba(0, 0, 0, .9))
        }

        /* Glow ring behind product */
        .tpl-cinema .cinema-glow {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 35%;
            border-radius: 50%;
            background: radial-gradient(ellipse, rgba(0, 212, 255, .15) 0%, rgba(168, 85, 247, .08) 40%, transparent 70%);
            z-index: 5;
            animation: none;
            filter: blur(20px);
            opacity: .3;
            transition: opacity .5s .5s
        }

        .tpl-cinema:hover .cinema-glow {
            opacity: .6;
            animation: cinemaGlow 4s ease-in-out infinite
        }

        @keyframes cinemaGlow {

            0%,
            100% {
                opacity: .6;
                transform: translateX(-50%) scale(1)
            }

            50% {
                opacity: 1;
                transform: translateX(-50%) scale(1.1)
            }
        }

        /* Content area */
        .tpl-cinema .content {
            position: absolute;
            bottom: 8%;
            left: 0;
            right: 0;
            height: 42%;
            padding: 16px 22px 18px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: flex-end;
            background: linear-gradient(to top, rgba(0, 0, 0, .95) 0%, rgba(0, 0, 0, .7) 50%, transparent 100%);
            z-index: 10
        }

        .tpl-cinema .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .tpl-cinema .logo-watermark {
            opacity: 1;
            height: 18px;
            background: rgba(255, 255, 255, .94);
            padding: 6px 12px;
            border-radius: 8px;
            backdrop-filter: blur(6px);
            display: block;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .15)
        }

        .tpl-cinema .stock-pill {
            background: rgba(0, 212, 255, .15);
            color: var(--accent);
            font-size: 8px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 999px;
            text-transform: uppercase;
            letter-spacing: .06em;
            border: 1px solid rgba(0, 212, 255, .2)
        }

        .tpl-cinema .hook {
            font-size: 24px;
            font-weight: 900;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: -.02em;
            background: linear-gradient(90deg, #fff 0%, var(--accent) 50%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: none;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden
        }

        .tpl-cinema:hover .hook {
            animation: shimmer 4s linear infinite
        }

        .tpl-cinema .name {
            font-size: 11px;
            color: rgba(255, 255, 255, .5);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .tpl-cinema .specs-line {
            font-size: 10px;
            color: rgba(255, 255, 255, .3);
            font-family: 'Courier New', monospace;
            letter-spacing: .04em
        }

        .tpl-cinema .price {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: -.03em;
            color: #fff;
            text-shadow: 0 0 30px rgba(0, 212, 255, .5), 0 0 60px rgba(0, 212, 255, .2)
        }

        .tpl-cinema .cta-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--brand) 50%, var(--neon-purple) 100%);
            background-size: 200% auto;
            animation: none;
            color: #fff;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: .06em;
            padding: 11px 18px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 212, 255, .3), 0 0 40px rgba(0, 212, 255, .1)
        }

        @keyframes cinemaCtaShift {

            0%,
            100% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }
        }

        .tpl-cinema .cta-url {
            font-size: 9px;
            text-align: center;
            color: rgba(255, 255, 255, .3);
            font-weight: 700;
            letter-spacing: .1em;
            text-transform: uppercase
        }

        .tpl-cinema:hover .cta-btn {
            animation: cinemaCtaShift 5s ease infinite
        }

        .tpl-cinema .template-label {
            background: linear-gradient(135deg, var(--accent), var(--neon-purple));
            color: #fff;
            top: auto;
            bottom: 6px;
            right: 6px;
            left: auto;
            z-index: 22
        }

        /* CINEMA Video recording indicator */
        .cinema-rec {
            position: absolute;
            top: 3%;
            right: 4%;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 9px;
            font-weight: 800;
            color: #ff3b3b;
            letter-spacing: .08em;
            z-index: 25;
            opacity: 0;
            transition: opacity .3s
        }

        .cinema-rec.active {
            opacity: 1
        }

        .cinema-rec .rec-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff3b3b;
            animation: recBlink 1s ease infinite
        }

        @keyframes recBlink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .2
            }
        }

        /* === v5.3: Enhanced BG States === */

        .bg-controls {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 2px
        }

        .bg-stats {
            font-size: 10px;
            color: var(--muted);
            padding: 2px 0
        }

        .bg-strength {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            padding: 4px 0
        }

        .bg-strength label {
            font-size: 10px;
            color: var(--muted);
            white-space: nowrap;
            min-width: 64px
        }

        .bg-strength input[type=range] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, .12);
            border-radius: 2px;
            outline: none;
            cursor: pointer
        }

        .bg-strength input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid rgba(255, 255, 255, .2);
            cursor: pointer
        }

        .bg-strength .strength-val {
            font-size: 10px;
            color: #e2e8f0;
            min-width: 28px;
            text-align: right;
            font-weight: 700
        }

        .card-toolbar .tb-btn.undo {
            color: #fbbf24;
            background: rgba(251, 191, 36, .15)
        }

        .card-toolbar .tb-btn.undo:hover {
            background: rgba(251, 191, 36, .3)
        }

        .card .product-img.enhanced {
            filter: drop-shadow(0 8px 24px rgba(0, 0, 0, .5)) drop-shadow(0 2px 8px rgba(0, 212, 255, .15));
            transition: filter .5s
        }

        /* === v6 ASSET MANAGER UX === */
        .card-toolbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 30;
            display: flex;
            gap: 3px;
            padding: 6px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, .85) 0%, rgba(0, 0, 0, .4) 70%, transparent);
            opacity: 0;
            transition: opacity .2s;
            pointer-events: none
        }

        .card:hover .card-toolbar,
        .card.editing .card-toolbar {
            opacity: 1;
            pointer-events: all
        }

        .card-toolbar .tb-btn {
            background: rgba(255, 255, 255, .12);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, .18);
            color: #fff;
            font-size: 11px;
            padding: 5px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all .15s;
            line-height: 1;
            font-family: inherit;
            font-weight: 700
        }

        .card-toolbar .tb-btn:hover {
            background: rgba(255, 255, 255, .25);
            transform: translateY(-1px)
        }

        .card-toolbar .tb-btn.del {
            margin-left: auto;
            color: #f87171
        }

        .card-toolbar .tb-btn.saved-ok {
            background: rgba(16, 185, 129, .3);
            color: #34d399;
            pointer-events: none
        }

        .card.editing {
            outline: 2px dashed var(--accent);
            outline-offset: -2px
        }

        .card.editing [contenteditable="true"] {
            outline: 1px dashed rgba(0, 212, 255, .35);
            outline-offset: 2px;
            cursor: text;
            border-radius: 3px
        }

        .card.editing [contenteditable="true"]:focus {
            outline: 2px solid var(--accent);
            background: rgba(0, 212, 255, .06)
        }

        .card .saved-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            z-index: 25;
            font-size: 8px;
            font-weight: 800;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(16, 185, 129, .2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, .3);
            opacity: 0;
            transition: opacity .3s;
            text-transform: uppercase;
            letter-spacing: .05em
        }

        .card.is-saved .saved-badge {
            opacity: 1
        }

        .card .product-url {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
            font-size: 8px;
            color: rgba(255, 255, 255, .3);
            text-align: center;
            padding: 2px 6px;
            background: rgba(0, 0, 0, .4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0;
            transition: opacity .2s
        }

        .card:hover .product-url {
            opacity: 1
        }

        /* ─── v8: Web CTA URL indicator ─── */
        .cta-url {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: .04em;
            text-align: center;
            opacity: .5;
            margin-top: -2px
        }

        .tpl-hero .cta-url,
        .tpl-neon .cta-url,
        .tpl-specs .cta-url {
            color: rgba(255, 255, 255, .45)
        }

        .tpl-split .cta-url,
        .tpl-minimal .cta-url {
            color: rgba(0, 0, 0, .3)
        }

        .pagination-bar {
            position: sticky;
            bottom: 0;
            width: 100%;
            padding: 10px 14px;
            background: rgba(7, 10, 14, .95);
            backdrop-filter: blur(12px);
            border-radius: 10px 10px 0 0;
            border: 1px solid var(--stroke);
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            z-index: 10;
            flex-shrink: 0
        }

        .pg-btn {
            background: rgba(255, 255, 255, .06);
            border: 1px solid var(--stroke);
            color: var(--text);
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all .15s;
            font-family: inherit
        }

        .pg-btn:hover:not(:disabled) {
            background: var(--brand);
            border-color: var(--brand)
        }

        .pg-btn:disabled {
            opacity: .25;
            cursor: default
        }

        .pg-btn.active {
            background: var(--brand);
            border-color: var(--brand)
        }

        .pg-info {
            font-size: 11px;
            color: var(--muted);
            padding: 0 6px
        }

        .lightbox {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, .92);
            backdrop-filter: blur(20px);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            padding: 40px
        }

        .lightbox.open {
            display: flex
        }

        .lightbox .lb-card-wrap {
            transform: scale(1.4);
            transform-origin: center
        }

        .lightbox .lb-card-wrap .card {
            pointer-events: none;
            cursor: default;
            animation: none
        }

        .lightbox .lb-card-wrap .card-toolbar,
        .lightbox .lb-card-wrap .select-check,
        .lightbox .lb-card-wrap .saved-badge {
            display: none !important
        }

        .lb-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, .1);
            border: 1px solid rgba(255, 255, 255, .2);
            color: #fff;
            font-size: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .2s;
            z-index: 5
        }

        .lb-close:hover {
            background: rgba(255, 255, 255, .2)
        }

        .lb-actions {
            display: flex;
            gap: 8px;
            z-index: 2
        }

        .count-row {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .count-row select {
            width: 70px;
            background: rgba(0, 0, 0, .4);
            border: 1px solid var(--stroke);
            color: var(--text);
            font-size: 11px;
            font-weight: 700;
            padding: 5px 6px;
            border-radius: 6px;
            font-family: inherit
        }

        .count-row .ct-label {
            font-size: 10px;
            color: var(--muted)
        }

        .count-row .ct-total {
            font-size: 10px;
            color: var(--accent);
            font-weight: 700
        }

        .asset-summary {
            display: flex;
            gap: 12px;
            font-size: 10px;
            color: var(--muted);
            padding: 6px 10px;
            background: rgba(0, 0, 0, .25);
            border-radius: 8px;
            border: 1px solid var(--stroke)
        }

        .asset-summary .av {
            font-weight: 800;
            color: var(--text)
        }

        .asset-summary .av-saved {
            color: #34d399
        }

        .asset-summary .av-edited {
            color: var(--accent)
        }
    </style>
</head>

<body>
    <div class="app">
        <section class="panel">
            <div class="panel-header">
                <img class="logo-img" src="/hellocomp_logo_website.svg" alt="HelloComp"
                    onerror="this.outerHTML='<span style=font-weight:900;font-size:13px>HELLOCOMP</span>'" />
                <span class="version">v6 ASSET</span>
            </div>

            <div class="section-label">Quick Actions</div>
            <div class="btn-row">
                <button class="btn" id="renderBtn">Generovat</button>
                <button class="btn secondary" id="clearBtn">Vyčistit</button>
                <button class="btn success" id="loadCacheBtn">&#x26A1; Heureka Feed (1051)</button>
            </div>

            <div class="section-label">Display & Sort</div>
            <div class="count-row">
                <span class="ct-label">Per page:</span>
                <select id="pageSizeSelect">
                    <option value="12">12</option>
                    <option value="24">24</option>
                    <option value="30" selected>30</option>
                    <option value="60">60</option>
                    <option value="120">120</option>
                    <option value="0">VŠE</option>
                </select>
                <span class="ct-label">Sort:</span>
                <select id="sortSelect">
                    <option value="price-desc" selected>💰 Cena ↓</option>
                    <option value="price-asc">💰 Cena ↑</option>
                    <option value="name-asc">📝 Název A-Z</option>
                    <option value="name-desc">📝 Název Z-A</option>
                    <option value="category">📁 Kategorie</option>
                </select>
                <span class="ct-total" id="totalProductsLabel">&mdash;</span>
            </div>
            <div class="asset-summary" id="assetSummary">
                <span><span class="av" id="asTotal">0</span> total</span>
                <span><span class="av av-saved" id="asSaved">0</span> saved</span>
                <span><span class="av av-edited" id="asEdited">0</span> edited</span>
            </div>

            <div class="section-label">Template Filter</div>
            <div class="template-chips" id="templateChips">
                <span class="chip active" data-tpl="all">Vše</span>
                <span class="chip" data-tpl="hero">Hero</span>
                <span class="chip" data-tpl="split">Split</span>
                <span class="chip" data-tpl="minimal">Minimal</span>
                <span class="chip" data-tpl="neon">Neon</span>
                <span class="chip" data-tpl="specs-focus">Specs</span>
                <span class="chip" data-tpl="cinema">Cinema</span>
            </div>

            <div class="section-label">Category Filter</div>
            <div class="template-chips" id="categoryChips">
                <span class="chip active" data-cat="all">Vše</span>
                <span class="chip" data-cat="pc">PC (361)</span>
                <span class="chip" data-cat="cpu">CPU (81)</span>
                <span class="chip" data-cat="phone">Mobily (77)</span>
                <span class="chip" data-cat="gpu">GPU (53)</span>
                <span class="chip" data-cat="headset">Sluchátka</span>
                <span class="chip" data-cat="notebook">Notebooky</span>
                <span class="chip" data-cat="peripheral">Periferie</span>
            </div>

            <div class="section-label">Lineup</div>
            <div class="template-chips" id="lineupChips">
                <span class="chip active" data-lineup="all">Vše</span>
                <span class="chip" data-lineup="GAMER SE">SE</span>
                <span class="chip" data-lineup="GAMER Pro">Pro</span>
                <span class="chip" data-lineup="GAMER Max">Max</span>
            </div>

            <div class="section-label">📦 Export Banners</div>
            <div class="btn-row">
                <button class="btn export" id="exportBtn">🖼 PNG Export All</button>
                <button class="btn small export" id="recordVideoBtn"
                    style="background:linear-gradient(135deg,var(--accent),var(--neon-purple));font-weight:800">🎬
                    Cinematic MP4</button>
            </div>
            <div class="export-picker" id="exportPicker">
                <button class="ep-btn active" data-format="1080x1920">9:16 Story</button>
                <button class="ep-btn" data-format="1080x1080">1:1 Post</button>
                <button class="ep-btn" data-format="1200x628">FB Banner</button>
                <button class="ep-btn" data-format="1920x1080">16:9 Wide</button>
            </div>

            <div class="section-label">�🎯 Smart Background Removal</div>
            <div class="bg-controls">
                <button class="btn small secondary" id="selectAllCardsBtn">☑ Select All</button>
                <button class="btn small secondary" id="deselectAllBtn">☐ Deselect</button>
            </div>
            <div class="btn-row">
                <button class="btn small success" id="removeBgSelectedBtn">🖼️ Remove BG (selected)</button>
                <button class="btn small export" id="preloadModelBtn">⚡ Preload AI</button>
            </div>
            <div id="bgProgress"></div>
            <div class="bg-stats" id="bgStats"></div>

            <div class="section-label">Smart Copy</div>
            <div class="btn-row">
                <button class="btn small secondary" id="generateCopyBtn">🧠 Generovat texty</button>
            </div>

            <div class="status-bar" id="statusText"></div>

            <textarea class="field" id="csvInput"
                placeholder="Klikni Generovat nebo Heureka Feed pro načtení produktů..."></textarea>
        </section>
        <main class="preview" id="cardsContainer"></main>
    </div>

    <div class="lightbox" id="lightbox" onclick="if(event.target===this)closeLightbox()">
        <button class="lb-close" onclick="closeLightbox()">&times;</button>
        <div class="lb-card-wrap" id="lbContent"></div>
        <div class="lb-actions">
            <button class="btn success" onclick="saveLightboxCard()">💾 Save PNG</button>
            <button class="btn secondary" onclick="closeLightbox()">Zavřít</button>
        </div>
    </div>

    <!-- ═══ Video Export Modal ═══ -->
    <div class="vex-overlay" id="vexOverlay" onclick="if(event.target===this)closeVex()">
        <div class="vex-panel">
            <div class="vex-header">
                <div class="vex-title">🎬 Video Export Studio</div>
                <button class="vex-close" onclick="closeVex()">&times;</button>
            </div>
            <div class="vex-body">
                <div class="vex-preview" id="vexPreview">
                    <div class="vex-preview-empty" id="vexPreviewEmpty">Select a card first</div>
                </div>
                <div class="vex-controls">
                    <div>
                        <div class="vex-field-label">Format / Dimensions</div>
                        <div class="vex-btn-group" id="vexFormatGroup">
                            <button class="vex-opt active" data-vfmt="1080x1920">9:16 Story</button>
                            <button class="vex-opt" data-vfmt="1080x1080">1:1 Post</button>
                            <button class="vex-opt" data-vfmt="1200x628">FB Banner</button>
                            <button class="vex-opt" data-vfmt="1920x1080">16:9 Wide</button>
                        </div>
                    </div>
                    <div>
                        <div class="vex-field-label">Duration</div>
                        <div class="vex-btn-group" id="vexDurationGroup">
                            <button class="vex-opt" data-vdur="5">5s Quick</button>
                            <button class="vex-opt" data-vdur="10">10s Short</button>
                            <button class="vex-opt active" data-vdur="15">15s Standard</button>
                            <button class="vex-opt" data-vdur="30">30s Extended</button>
                        </div>
                    </div>
                    <div>
                        <div class="vex-field-label">Quality</div>
                        <div class="vex-btn-group" id="vexQualityGroup">
                            <button class="vex-opt" data-vq="standard" data-br="6000000">Standard (6 Mbps)</button>
                            <button class="vex-opt active" data-vq="high" data-br="12000000">High (12 Mbps)</button>
                            <button class="vex-opt" data-vq="ultra" data-br="20000000">Ultra (20 Mbps)</button>
                        </div>
                    </div>
                    <div>
                        <div class="vex-field-label">Output Format</div>
                        <div class="vex-btn-group" id="vexOutputGroup">
                            <button class="vex-opt active" data-vout="mp4">MP4 (H.264)</button>
                            <button class="vex-opt" data-vout="webm">WebM (VP9)</button>
                        </div>
                    </div>
                    <button class="vex-render-btn" id="vexRenderBtn" onclick="vexRender()">
                        🎬 Render Video
                    </button>
                    <div class="vex-progress" id="vexProgress">
                        <div class="vex-progress-bar">
                            <div class="vex-progress-fill" id="vexProgressFill"></div>
                        </div>
                        <div class="vex-progress-text" id="vexProgressText">Preparing...</div>
                    </div>
                </div>
            </div>
            <div class="vex-footer">
                <div class="vex-info">Resolution: <span class="vex-info-val" id="vexResVal">1080×1920</span></div>
                <div class="vex-info">Frames: <span class="vex-info-val" id="vexFramesVal">450</span></div>
                <div class="vex-info">Est. size: <span class="vex-info-val" id="vexSizeVal">~22 MB</span></div>
            </div>
        </div>
    </div>

    <script>
        /* ===========================
           HelloComp Photo Post Factory v5 FUSION
           Category Intelligence + Futuristic FX + Conversion Engine
           =========================== */

        // ─── Neon template particles ───
        function heroParticlesHtml() {
            var html = '';
            for (var i = 0; i < 18; i++) {
                var left = Math.round(Math.random() * 100);
                var dur = 4 + Math.random() * 6;
                var delay = Math.random() * 6;
                var size = 2 + Math.random() * 3;
                var colors = ['rgba(33,102,204,.7)', 'rgba(0,212,255,.6)', 'rgba(168,85,247,.5)', 'rgba(255,255,255,.4)'];
                var color = colors[Math.floor(Math.random() * colors.length)];
                html += '<div class="h-spark" style="left:' + left + '%;bottom:0;width:' + size + 'px;height:' + size + 'px;background:' + color + ';animation-duration:' + dur + 's;animation-delay:' + delay + 's"></div>';
            }
            return html;
        }

        function neonParticles() {
            let html = '';
            for (let i = 0; i < 16; i++) {
                const left = Math.round(Math.random() * 100);
                const dur = 3 + Math.random() * 4;
                const delay = Math.random() * 5;
                const size = 2 + Math.random() * 3;
                const hue = Math.random() > 0.5 ? 'var(--accent)' : 'var(--neon-purple)';
                html += '<div class="particle" style="left:' + left + '%;width:' + size + 'px;height:' + size + 'px;background:' + hue + ';animation-duration:' + dur + 's;animation-delay:' + delay + 's"></div>';
            }
            return html;
        }

        function cinemaParticlesHtml() {
            var html = '';
            for (var i = 0; i < 20; i++) {
                var left = Math.round(Math.random() * 100);
                var dur = 6 + Math.random() * 8;
                var delay = Math.random() * 8;
                var size = 2 + Math.random() * 3;
                var colors = ['rgba(0,212,255,.6)', 'rgba(168,85,247,.5)', 'rgba(33,102,204,.5)', 'rgba(255,255,255,.3)'];
                var color = colors[Math.floor(Math.random() * colors.length)];
                html += '<div class="c-particle" style="left:' + left + '%;width:' + size + 'px;height:' + size + 'px;background:' + color + ';animation-duration:' + dur + 's;animation-delay:' + delay + 's"></div>';
            }
            return html;
        }

        // ─── v5: GPU Brand Detection ───
        function detectGpuBrand(gpuStr) {
            if (!gpuStr) return { brand: 'unknown', series: '', tier: 0 };
            const g = gpuStr.toUpperCase();
            let brand = 'unknown', series = '', tier = 50;
            if (g.includes('RTX 50')) { brand = 'nvidia'; series = 'RTX 50'; tier = 100; }
            else if (g.includes('RTX 40')) { brand = 'nvidia'; series = 'RTX 40'; tier = 90; }
            else if (g.includes('RTX 30')) { brand = 'nvidia'; series = 'RTX 30'; tier = 75; }
            else if (g.includes('RTX 20')) { brand = 'nvidia'; series = 'RTX 20'; tier = 60; }
            else if (g.includes('GTX 16')) { brand = 'nvidia'; series = 'GTX 16'; tier = 45; }
            else if (g.includes('GTX 10')) { brand = 'nvidia'; series = 'GTX 10'; tier = 35; }
            else if (g.includes('RX 9')) { brand = 'amd'; series = 'RX 9000'; tier = 95; }
            else if (g.includes('RX 7')) { brand = 'amd'; series = 'RX 7000'; tier = 85; }
            else if (g.includes('RX 6')) { brand = 'amd'; series = 'RX 6000'; tier = 70; }
            else if (g.includes('RX 5')) { brand = 'amd'; series = 'RX 5000'; tier = 55; }
            else if (g.includes('NVIDIA') || g.includes('GEFORCE') || g.includes('QUADRO')) { brand = 'nvidia'; series = 'NVIDIA'; }
            else if (g.includes('AMD') || g.includes('RADEON')) { brand = 'amd'; series = 'AMD'; }
            return { brand, series, tier };
        }

        // ─── v5: Category Detection (Heureka-aware) ───
        function detectCategory(product) {
            // Heureka JSON has category.slug pre-classified
            if (product.category && product.category.slug) return product.category.slug;
            // Fallback for CSV rows with _category field
            if (product._category) return product._category;
            // Legacy fallback: if has full specs, it's a PC
            const s = product.specs || {};
            if (s.cpu && s.cpu !== 'N/A' && s.gpu && s.gpu !== 'N/A') return 'pc';
            return 'other';
        }

        // ─── v5: Lineup Badge HTML ───
        function lineupBadgeHtml(lineup) {
            if (!lineup) return '';
            const cls = lineup.includes('Max') ? 'max' : lineup.includes('Pro') ? 'pro' : 'se';
            const label = lineup.includes('Max') ? 'GAMER MAX' : lineup.includes('Pro') ? 'GAMER PRO' : 'GAMER SE';
            return '<div class="lineup-badge ' + cls + '">' + label + '</div>';
        }

        // ─── v5: GPU Brand Badge HTML ───
        function gpuBadgeHtml(gpuInfo) {
            if (!gpuInfo || gpuInfo.brand === 'unknown') return '';
            return '<span class="gpu-badge ' + gpuInfo.brand + '">' + gpuInfo.series + '</span>';
        }

        // ─── v5: Urgency pill HTML ───
        function urgencyHtml(product) {
            const stock = product._stock || 0;
            if (stock > 0 && stock <= 5) return '<span class="urgency-pill">Zbývá jen ' + stock + ' ks!</span>';
            if (stock > 5 && stock <= 15) return '<span class="urgency-pill hot">Poslední kusy</span>';
            return '';
        }

        // ─── v5: Social Proof HTML ───
        function socialProofHtml() {
            const proofs = [
                '500+ prodaných tento měsíc',
                'Nejprodávanější sestava',
                'Doporučeno 98% hráčů',
                'Výběr měsíce',
                'Top volba komunity',
                'Ověřeno 200+ recenzemi'
            ];
            return '<div class="social-proof"><span class="dot"></span>' + proofs[Math.floor(Math.random() * proofs.length)] + '</div>';
        }

        // ─── v5: Energy Meter HTML (spec bars) ───
        function energyMeterHtml(specs, gpuInfo) {
            if (!specs || !specs.gpu || specs.gpu === 'N/A') return '';
            const rows = [];
            if (specs.gpu && specs.gpu !== 'N/A') {
                rows.push({ label: 'GPU', cls: 'gpu', value: specs.gpu.substring(0, 28), pct: Math.min(gpuInfo.tier + 5, 100) });
            }
            if (specs.cpu && specs.cpu !== 'N/A') {
                const cpuTier = specs.cpu.toUpperCase().includes('I9') || specs.cpu.toUpperCase().includes('RYZEN 9') ? 90 :
                    specs.cpu.toUpperCase().includes('I7') || specs.cpu.toUpperCase().includes('RYZEN 7') ? 75 :
                        specs.cpu.toUpperCase().includes('I5') || specs.cpu.toUpperCase().includes('RYZEN 5') ? 55 : 40;
                rows.push({ label: 'CPU', cls: 'cpu', value: specs.cpu.substring(0, 28), pct: cpuTier });
            }
            if (specs.ram && specs.ram !== 'N/A') {
                const ramGb = parseInt(specs.ram) || 8;
                const ramPct = Math.min(ramGb * 2.5, 100);
                rows.push({ label: 'RAM', cls: 'ram', value: specs.ram, pct: ramPct });
            }
            if (!rows.length) return '';
            return '<div class="energy-meter">' + rows.map((r, i) =>
                '<div class="energy-row">'
                + '<span class="energy-label">' + r.label + '</span>'
                + '<div class="energy-bar"><div class="energy-fill ' + r.cls + '" style="width:' + r.pct + '%;animation-delay:' + (0.3 + i * 0.15) + 's"></div></div>'
                + '<span class="energy-value">' + r.value + '</span>'
                + '</div>'
            ).join('') + '</div>';
        }

        // ─── Smart Copy Engine (v5 — category aware) ───
        const copyEngine = (function () {
            // ─── v7: Product-aware smart copy ───
            // Hooks are now SPEC-DRIVEN, not random buzzwords
            const ctaByCategory = {
                pc: ['NAKONFIGUROVAT', 'ZOBRAZIT SESTAVU', 'OBJEDNAT PC', 'VYBRAT KONFIGURACI', 'MÁM ZÁJEM'],
                gpu: ['KOUPIT GRAFIKU', 'DO KOŠÍKU', 'OBJEDNAT', 'CHCI UPGRADE'],
                notebook: ['ZOBRAZIT NOTEBOOK', 'OBJEDNAT', 'CHCI HO', 'MÁM ZÁJEM'],
                cpu: ['KOUPIT PROCESOR', 'DO KOŠÍKU', 'OBJEDNAT', 'UPGRADE CPU'],
                phone: ['KOUPIT TELEFON', 'OBJEDNAT', 'CHCI HO', 'DO KOŠÍKU'],
                headset: ['KOUPIT', 'DO KOŠÍKU', 'OBJEDNAT', 'CHCI JE'],
                monitor: ['KOUPIT MONITOR', 'OBJEDNAT', 'DO KOŠÍKU', 'MÁM ZÁJEM'],
                peripheral: ['KOUPIT', 'DO KOŠÍKU', 'OBJEDNAT TEĎ'],
                default: ['OBJEDNAT', 'DO KOŠÍKU', 'ZJISTIT VÍCE', 'KOUPIT', 'MÁM ZÁJEM']
            };

            const used = { hooks: new Set(), claims: new Set(), ctas: new Set() };

            function pickUnique(arr, usedSet) {
                const available = arr.filter(x => !usedSet.has(x));
                const pool = available.length > 0 ? available : arr;
                const pick = pool[Math.floor(Math.random() * pool.length)];
                usedSet.add(pick);
                return pick;
            }

            function getTier(priceStr) {
                const n = parseInt(String(priceStr).replace(/[^\d]/g, ''), 10);
                if (isNaN(n) || n < 17000) return 'budget';
                if (n < 30000) return 'mid';
                if (n < 50000) return 'premium';
                return 'ultra';
            }

            // Shorten GPU name: "NVIDIA RTX 5090" → "RTX 5090"
            function shortGpu(g) {
                return (g || '').replace(/NVIDIA\s+|AMD\s+|GeForce\s+|Radeon\s+/gi, '').trim();
            }
            // Shorten CPU name: "AMD Ryzen 9 9950X3D" → "Ryzen 9 9950X3D"
            function shortCpu(c) {
                return (c || '').replace(/AMD\s+|Intel\s+/gi, '').trim();
            }

            function generate(priceStr, category, product) {
                const tier = getTier(priceStr);
                const s = (product && product.specs) ? product.specs : {};
                const gpuS = shortGpu(s.gpu);
                const cpuS = shortCpu(s.cpu);
                let hook = '';
                let claim = '';

                // ── HOOK: spec-driven, unique per product ──
                if (category === 'pc' || category === 'notebook') {
                    if (gpuS && cpuS) {
                        // Mix patterns to avoid repetition
                        const patterns = [
                            gpuS + ' \u2022 ' + cpuS + (s.ram ? ' \u2022 ' + s.ram : ''),
                            cpuS + ' + ' + gpuS + (s.vram ? ' ' + s.vram : ''),
                            gpuS + (s.vram ? ' ' + s.vram : '') + ' | ' + s.ram + ' RAM',
                            (s.cpuCores ? s.cpuCores + ' JADER \u2022 ' : '') + gpuS + ' \u2022 ' + s.ram
                        ];
                        hook = pickUnique(patterns, used.hooks);
                    } else if (gpuS) {
                        hook = gpuS + (s.vram ? ' ' + s.vram : '') + (s.ram ? ' | ' + s.ram + ' RAM' : '');
                    } else if (cpuS) {
                        hook = cpuS + (s.ram ? ' \u2022 ' + s.ram : '');
                    } else {
                        hook = (product && product.name) ? product.name.replace(/HelloComp\s*/i, '').substring(0, 40) : 'HERNÍ SESTAVA';
                    }
                } else if (category === 'gpu') {
                    hook = gpuS + (s.vram ? ' ' + s.vram + ' VRAM' : '');
                    if (!hook) hook = (product && product.name) || 'GRAFICKÁ KARTA';
                } else if (category === 'cpu') {
                    hook = cpuS + (s.cpuCores ? ' \u2022 ' + s.cpuCores + ' jader' : '') + (s.cpuFreq ? ' \u2022 ' + s.cpuFreq : '');
                    if (!hook.trim()) hook = (product && product.name) || 'PROCESOR';
                } else if (category === 'monitor') {
                    hook = (product && product.name) ? product.name.replace(/HelloComp\s*/i, '').substring(0, 45) : 'MONITOR';
                } else if (category === 'headset') {
                    hook = (product && product.name) ? product.name.replace(/HelloComp\s*/i, '').substring(0, 45) : 'HERNÍ SLUCHÁTKA';
                } else if (category === 'phone') {
                    hook = (product && product.name) ? product.name.replace(/HelloComp\s*/i, '').substring(0, 45) : 'SMARTPHONE';
                } else {
                    // Accessories, peripherals, etc. — use product name as hook
                    hook = (product && product.name) ? product.name.replace(/HelloComp\s*/i, '').substring(0, 40) : 'PŘÍSLUŠENSTVÍ';
                }

                // ── CLAIM: contextual product description ──
                if (category === 'pc') {
                    const highlights = [];
                    if (gpuS) highlights.push(gpuS);
                    if (s.storage) highlights.push(s.storage);
                    if (s.os && s.os !== 'dle výběru') highlights.push(s.os);
                    // HelloComp USPs mixed in
                    const usps = [
                        highlights.length ? 'Herní PC s ' + highlights.join(', ') : 'Herní PC od HelloComp',
                        'Sestaveno v ČR \u2022 2 roky záruka \u2022 ' + (s.storage || 'SSD'),
                        (s.cpuCores ? s.cpuCores + '\u00D7 CPU' : 'Multi-core') + ' + ' + (gpuS || 'dedikovaná GPU') + ' \u2022 Ready to play',
                        'HelloComp \u2022 Profesionální sestava' + (s.ram ? ' \u2022 ' + s.ram + ' RAM' : '')
                    ];
                    claim = pickUnique(usps, used.claims);
                } else if (category === 'notebook') {
                    claim = 'Herní notebook' + (gpuS ? ' s ' + gpuS : '') + (s.ram ? ' \u2022 ' + s.ram : '') + ' od HelloComp';
                } else if (category === 'gpu') {
                    const vr = s.vram ? s.vram + ' VRAM \u2022 ' : '';
                    claim = vr + 'Grafická karta pro náročné hráče \u2022 HelloComp';
                } else if (category === 'cpu') {
                    claim = 'Procesor' + (s.cpuCores ? ' ' + s.cpuCores + ' jader' : '') + ' \u2022 Srdce každé sestavy';
                } else if (category === 'phone') {
                    claim = 'Prémiový smartphone \u2022 Expedice do 24h';
                } else if (category === 'headset') {
                    claim = 'Herní audio \u2022 Slyš každý detail \u2022 HelloComp';
                } else if (category === 'monitor') {
                    claim = 'Gaming monitor \u2022 Plynulý obraz \u2022 HelloComp';
                } else {
                    claim = 'Kvalitní hardware \u2022 Expedice do 24h \u2022 HelloComp';
                }

                // ── CTA: category-specific ──
                const ctaArr = ctaByCategory[category] || ctaByCategory.default;
                return {
                    hook: hook,
                    claim: claim,
                    cta: pickUnique(ctaArr, used.ctas),
                    tier: tier
                };
            }

            function reset() { used.hooks.clear(); used.claims.clear(); used.ctas.clear(); }

            return { generate, reset, getTier };
        })();

        // ─── Logo helper ───
        function logoHtml(dark) {
            var src = '/hellocomp_logo_website.svg';
            return '<img class="logo-watermark" src="' + src + '" alt="HC" onerror="this.outerHTML=\'<span style=font-weight:900;font-size:11px;opacity:.6>HELLOCOMP</span>\'">';
        }

        // ─── Parse specs ───
        function parseSpecs(specsStr) {
            if (!specsStr) return { cpu: '', gpu: '', ram: '', items: [] };
            const parts = specsStr.split('/').map(s => s.trim());
            return {
                cpu: parts[0] || '',
                gpu: parts[1] || '',
                ram: parts[2] || '',
                items: parts
            };
        }

        // ─── v5: Format price for display ───
        function formatPrice(price) {
            if (!price && price !== 0) return '0 Kč';
            const n = typeof price === 'number' ? price : parseInt(String(price).replace(/[^\d]/g, ''));
            if (isNaN(n)) return price;
            return n.toLocaleString('cs-CZ') + ' Kč';
        }

        // ─── Template Renderers (v5 FUSION) ───
        const templates = {
            hero(p) {
                const s = parseSpecs(p.specs);
                const gpu = detectGpuBrand(s.gpu || p._gpuRaw);
                const isPremium = gpu.tier >= 75;
                const cls = 'card tpl-hero cyber-grid scanner-line' + (isPremium ? ' holo-shimmer' : '');
                return '<div class="' + cls + '" data-tpl="hero" data-cat="' + (p._category || '') + '" data-lineup="' + (p._lineup || '') + '">'
                    + '<div class="hero-edge-glow"></div>'
                    + '<div class="hero-aurora"></div>'
                    + '<div class="hero-rays"></div>'
                    + '<div class="hero-particles">' + heroParticlesHtml() + '</div>'
                    + '<div class="hero-flare"></div>'
                    + '<div class="hero-spotlight"></div>'
                    + '<div class="data-stream"></div>'
                    + lineupBadgeHtml(p._lineup)
                    + '<span class="template-label">HERO</span>'
                    + '<div class="product-zone"><img class="product-img" src="' + p.image_url + '" alt="' + (p.image_alt || p.product_name) + '"/></div>'
                    + '<div class="content">'
                    + '<div class="hero-glow-bar"></div>'
                    + '<div class="logo-row">' + logoHtml(true) + gpuBadgeHtml(gpu) + '<span class="stock-pill">' + (p.badge_stock || 'SKLADEM') + '</span></div>'
                    + '<div class="hook">' + p.hook + '</div>'
                    + '<div class="name">' + p.product_name + '</div>'
                    + '<div class="specs-line">' + p.specs + '</div>'
                    + socialProofHtml()
                    + '<div class="price-row"><div class="price">' + p.price + '</div>' + urgencyHtml(p) + '</div>'
                    + '<div class="cta-btn">' + (p.cta || 'OBJEDNAT') + '</div>'
                    + '<div class="cta-url">hellocomp.cz</div>'
                    + '</div>'
                    + '</div>';
            },

            split(p) {
                const s = parseSpecs(p.specs);
                const gpu = detectGpuBrand(s.gpu || p._gpuRaw);
                const specTags = s.items.map(i => '<span class="spec-tag">' + i + '</span>').join('');
                return '<div class="card tpl-split" data-tpl="split" data-cat="' + (p._category || '') + '" data-lineup="' + (p._lineup || '') + '">'
                    + lineupBadgeHtml(p._lineup)
                    + '<span class="template-label">SPLIT</span>'
                    + '<div class="product-zone"><img class="product-img" src="' + p.image_url + '" alt="' + (p.image_alt || p.product_name) + '"/></div>'
                    + '<div class="content">'
                    + '<div class="logo-row">' + logoHtml(false) + gpuBadgeHtml(gpu) + '<span class="stock-pill">' + (p.badge_stock || 'SKLADEM') + '</span></div>'
                    + '<div class="divider"></div>'
                    + '<div class="hook">' + p.hook + '</div>'
                    + '<div class="name">' + p.product_name + '</div>'
                    + '<div class="specs-grid">' + specTags + '</div>'
                    + '<div class="price-row"><div class="price">' + p.price + '</div>' + urgencyHtml(p) + '</div>'
                    + '<div class="cta-btn">' + (p.cta || 'OBJEDNAT') + '</div>'
                    + '<div class="cta-url">hellocomp.cz</div>'
                    + '</div>'
                    + '</div>';
            },

            minimal(p) {
                const s = parseSpecs(p.specs);
                const gpu = detectGpuBrand(s.gpu || p._gpuRaw);
                return '<div class="card tpl-minimal" data-tpl="minimal" data-cat="' + (p._category || '') + '" data-lineup="' + (p._lineup || '') + '">'
                    + lineupBadgeHtml(p._lineup)
                    + '<span class="template-label">MINIMAL</span>'
                    + '<div class="product-zone"><img class="product-img" src="' + p.image_url + '" alt="' + (p.image_alt || p.product_name) + '"/></div>'
                    + '<div class="content">'
                    + '<div class="logo-row">' + logoHtml(false) + gpuBadgeHtml(gpu) + '<span class="stock-tag">' + (p.badge_stock || 'SKLADEM') + '</span></div>'
                    + '<div class="claim">' + (p.positioning_claim || '') + '</div>'
                    + '<div class="hook">' + p.hook + '</div>'
                    + '<div class="name">' + p.product_name + '</div>'
                    + '<div class="specs-line">' + p.specs + '</div>'
                    + '<div class="price-row"><div class="price">' + p.price + '</div></div>'
                    + '<div class="cta-btn">' + (p.cta || 'OBJEDNAT') + '</div>'
                    + '<div class="cta-url">hellocomp.cz</div>'
                    + '</div>'
                    + '</div>';
            },

            neon(p) {
                const s = parseSpecs(p.specs);
                const gpu = detectGpuBrand(s.gpu || p._gpuRaw);
                const specsObj = { cpu: s.cpu, gpu: s.gpu, ram: s.ram, storage: s.items[3] || '' };
                return '<div class="card tpl-neon cyber-grid scanner-line holo-shimmer" data-tpl="neon" data-cat="' + (p._category || '') + '" data-lineup="' + (p._lineup || '') + '">'
                    + '<div class="data-stream"></div>'
                    + lineupBadgeHtml(p._lineup)
                    + '<span class="template-label">NEON</span>'
                    + '<div class="glow-ring"></div>'
                    + '<div class="particles">' + neonParticles() + '</div>'
                    + '<div class="product-zone"><img class="product-img" src="' + p.image_url + '" alt="' + (p.image_alt || p.product_name) + '"/></div>'
                    + '<div class="content">'
                    + '<div class="logo-row">' + logoHtml(true) + gpuBadgeHtml(gpu) + '<span class="stock-pill">' + (p.badge_stock || 'SKLADEM') + '</span></div>'
                    + '<div class="claim">' + (p.positioning_claim || 'ELITE GAMING') + '</div>'
                    + '<div class="hook">' + p.hook + '</div>'
                    + '<div class="name">' + p.product_name + '</div>'
                    + energyMeterHtml(specsObj, gpu)
                    + socialProofHtml()
                    + '<div class="price">' + p.price + '</div>'
                    + urgencyHtml(p)
                    + '<div class="cta-btn">' + (p.cta || 'OBJEDNAT') + '</div>'
                    + '<div class="cta-url">hellocomp.cz</div>'
                    + '</div>'
                    + '</div>';
            },

            'specs-focus'(p) {
                const s = parseSpecs(p.specs);
                const gpu = detectGpuBrand(s.gpu || p._gpuRaw);
                const specsObj = { cpu: s.cpu, gpu: s.gpu, ram: s.ram, storage: s.items[3] || '' };
                const specRows = [
                    { icon: 'CPU', label: 'PROCESOR', value: s.cpu },
                    { icon: 'GPU', label: 'GRAFIKA', value: s.gpu },
                    { icon: 'RAM', label: 'PAMĚŤ', value: s.ram }
                ].filter(r => r.value).map(r =>
                    '<div class="spec-row">'
                    + '<div class="spec-icon">' + r.icon + '</div>'
                    + '<div><div class="spec-label">' + r.label + '</div><div class="spec-value">' + r.value + '</div></div>'
                    + '</div>'
                ).join('');
                return '<div class="card tpl-specs cyber-grid" data-tpl="specs-focus" data-cat="' + (p._category || '') + '" data-lineup="' + (p._lineup || '') + '">'
                    + '<div class="data-stream"></div>'
                    + lineupBadgeHtml(p._lineup)
                    + '<span class="template-label">SPECS</span>'
                    + '<div class="product-zone"><img class="product-img" src="' + p.image_url + '" alt="' + (p.image_alt || p.product_name) + '"/></div>'
                    + '<div class="content">'
                    + '<div class="logo-row">' + logoHtml(true) + gpuBadgeHtml(gpu) + '<span class="stock-pill">' + (p.badge_stock || 'SKLADEM') + '</span></div>'
                    + '<div class="hook">' + p.hook + '</div>'
                    + '<div class="name">' + p.product_name + '</div>'
                    + '<div class="specs-table">' + specRows + '</div>'
                    + energyMeterHtml(specsObj, gpu)
                    + '<div class="price-row"><div class="price">' + p.price + '</div>' + urgencyHtml(p) + '</div>'
                    + '<div class="cta-btn">' + (p.cta || 'OBJEDNAT') + '</div>'
                    + '<div class="cta-url">hellocomp.cz</div>'
                    + '</div>'
                    + '</div>';
            },

            cinema(p) {
                const s = parseSpecs(p.specs);
                const gpu = detectGpuBrand(s.gpu || p._gpuRaw);
                const specsLine = s.items.join(' / ');
                return '<div class="card tpl-cinema" data-tpl="cinema" data-cat="' + (p._category || '') + '" data-lineup="' + (p._lineup || '') + '">'
                    + '<div class="cinema-bg"></div>'
                    + '<div class="cinema-particles">' + cinemaParticlesHtml() + '</div>'
                    + '<div class="cinema-sweep"></div>'
                    + '<div class="cinema-scanlines"></div>'
                    + '<div class="cinema-glow"></div>'
                    + '<div class="cinema-bar top"></div>'
                    + '<div class="cinema-bar bottom"></div>'
                    + '<div class="cinema-rec"><div class="rec-dot"></div>REC</div>'
                    + lineupBadgeHtml(p._lineup)
                    + '<span class="template-label">CINEMA</span>'
                    + '<div class="product-zone"><img class="product-img" src="' + p.image_url + '" alt="' + (p.image_alt || p.product_name) + '"/></div>'
                    + '<div class="content">'
                    + '<div class="logo-row">' + logoHtml(true) + gpuBadgeHtml(gpu) + '<span class="stock-pill">' + (p.badge_stock || 'SKLADEM') + '</span></div>'
                    + '<div class="hook">' + p.hook + '</div>'
                    + '<div class="name">' + p.product_name + '</div>'
                    + '<div class="specs-line">' + specsLine + '</div>'
                    + energyMeterHtml({ cpu: s.cpu, gpu: s.gpu, ram: s.ram }, gpu)
                    + socialProofHtml()
                    + '<div class="price">' + p.price + '</div>'
                    + urgencyHtml(p)
                    + '<div class="cta-btn">' + (p.cta || 'OBJEDNAT') + '</div>'
                    + '<div class="cta-url">hellocomp.cz</div>'
                    + '</div>'
                    + '</div>';
            },


        };

        // ─── CSV Parser ───
        function parseCSV(csv) {
            const lines = csv.trim().split('\n').filter(l => l.trim());
            if (lines.length < 2) return [];
            const headers = lines[0].split(';').map(h => h.trim());
            return lines.slice(1).map(line => {
                const vals = line.split(';');
                const obj = {};
                headers.forEach((h, i) => { obj[h] = vals[i] ? vals[i].trim() : '' });
                return obj;
            });
        }

        // ─── State ───
        let currentFilter = 'all';
        let currentCategory = 'all';
        let currentLineup = 'all';
        let currentPage = 0;
        let pageSize = 30;
        let lastFilteredCount = 0;
        let cachedProducts = []; // v5: holds JSON cache data

        // ─── v6: Inject per-card toolbar ───
        function injectCardToolbar(card) {
            const toolbar = document.createElement('div');
            toolbar.className = 'card-toolbar';
            toolbar.innerHTML = ''
                + '<button class="tb-btn save" onclick="event.stopPropagation();saveCardAsPNG(this.closest(\'.card\'))" title="Uložit jako PNG">\uD83D\uDCBE</button>'
                + '<button class="tb-btn edit" onclick="event.stopPropagation();toggleEditMode(this.closest(\'.card\'))" title="Upravit texty">\u270F\uFE0F</button>'
                + '<button class="tb-btn bg" onclick="event.stopPropagation();removeBgToolbar(this)" title="Odstranit pozadí">\uD83D\uDDBC</button>'
                + '<button class="tb-btn undo" onclick="event.stopPropagation();undoBgToolbar(this)" title="Vrátit původní" style="display:none">↩️</button>'
                + '<button class="tb-btn" onclick="event.stopPropagation();openLightbox(this.closest(\'.card\'))" title="Zvětšit">\uD83D\uDD0D</button>'
                + '<button class="tb-btn del" onclick="event.stopPropagation();this.closest(\'.card\').remove();updateCount();updateAssetSummary()" title="Smazat">\u2715</button>';
            card.insertBefore(toolbar, card.firstChild);
            // v7: Template switcher
            const currentTpl = card.dataset.tpl || 'hero';
            const switcher = document.createElement('div');
            switcher.className = 'tpl-switcher';
            const tplNames = [
                { key: 'hero', label: 'H' },
                { key: 'split', label: 'S' },
                { key: 'minimal', label: 'M' },
                { key: 'neon', label: 'N' },
                { key: 'specs-focus', label: 'Sp' },
                { key: 'cinema', label: 'C' }
            ];
            switcher.innerHTML = tplNames.map(function (t) {
                return '<button class="ts-btn' + (t.key === currentTpl ? ' active' : '') + '" data-tpl="' + t.key + '" onclick="event.stopPropagation();switchCardTemplate(this.closest(\'.card\'),\'' + t.key + '\')" title="' + t.key + '">' + t.label + '</button>';
            }).join('');
            card.appendChild(switcher);
            // Selection check circle
            const chk = document.createElement('div');
            chk.className = 'select-check';
            chk.textContent = '\u2713';
            card.appendChild(chk);
            // Saved badge
            const badge = document.createElement('div');
            badge.className = 'saved-badge';
            badge.textContent = '\uD83D\uDCBE SAVED';
            card.appendChild(badge);
            // Product URL strip (shows on hover)
            if (card.dataset.url) {
                const urlStrip = document.createElement('div');
                urlStrip.className = 'product-url';
                urlStrip.textContent = card.dataset.url;
                card.appendChild(urlStrip);
            }
        }

        // ─── v6: Render pagination bar ───
        function renderPagination(container, totalPages, totalItems) {
            if (totalPages <= 1) return;
            let html = '<div class="pagination-bar">';
            html += '<button class="pg-btn" onclick="navigatePage(0)" ' + (currentPage === 0 ? 'disabled' : '') + '>\u25C0\u25C0</button>';
            html += '<button class="pg-btn" onclick="navigatePage(' + (currentPage - 1) + ')" ' + (currentPage === 0 ? 'disabled' : '') + '>\u25C0 Prev</button>';
            const maxVis = 7;
            let startPg = Math.max(0, currentPage - Math.floor(maxVis / 2));
            let endPg = Math.min(totalPages, startPg + maxVis);
            if (endPg - startPg < maxVis) startPg = Math.max(0, endPg - maxVis);
            for (let pg = startPg; pg < endPg; pg++) {
                html += '<button class="pg-btn' + (pg === currentPage ? ' active' : '') + '" onclick="navigatePage(' + pg + ')">' + (pg + 1) + '</button>';
            }
            html += '<button class="pg-btn" onclick="navigatePage(' + (currentPage + 1) + ')" ' + (currentPage >= totalPages - 1 ? 'disabled' : '') + '>Next \u25B6</button>';
            html += '<button class="pg-btn" onclick="navigatePage(' + (totalPages - 1) + ')" ' + (currentPage >= totalPages - 1 ? 'disabled' : '') + '>\u25B6\u25B6</button>';
            html += '<span class="pg-info">' + totalItems + ' produkt\u016F</span>';
            html += '</div>';
            container.insertAdjacentHTML('beforeend', html);
        }

        // ─── Render cards (v6 — paginated + toolbar) ───
        function renderCards() {
            const csv = document.getElementById('csvInput').value;
            const products = parseCSV(csv);
            if (!products.length) { setStatus('Žádné produkty v CSV.', '#f87171'); return; }
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            const templateKeys = Object.keys(templates);

            // Step 1: resolve templates + filter
            const filtered = [];
            products.forEach((p, i) => {
                let tpl = (p.template || '').trim().toLowerCase();
                if (!templates[tpl]) tpl = templateKeys[i % templateKeys.length];
                if (currentFilter !== 'all' && tpl !== currentFilter) return;
                if (currentCategory !== 'all' && p._category !== currentCategory) return;
                if (currentLineup !== 'all' && p._lineup !== currentLineup) return;
                filtered.push(Object.assign({}, p, { _resolvedTpl: tpl }));
            });

            lastFilteredCount = filtered.length;
            const effectivePageSize = pageSize === 0 ? filtered.length : pageSize;
            const totalPages = Math.max(1, Math.ceil(filtered.length / effectivePageSize));
            if (currentPage >= totalPages) currentPage = totalPages - 1;
            if (currentPage < 0) currentPage = 0;
            const start = currentPage * effectivePageSize;
            const pageItems = filtered.slice(start, start + effectivePageSize);

            // Step 2: render page items
            pageItems.forEach(function (p) {
                const html = templates[p._resolvedTpl](p);
                container.insertAdjacentHTML('beforeend', html);
            });

            // Count bar
            const catLabel = currentCategory === 'all' ? 'vše' : currentCategory;
            const lineLabel = currentLineup === 'all' ? 'vše' : currentLineup;
            const countBar = '<div class="preview-count">'
                + '<strong>' + pageItems.length + ' / ' + filtered.length + ' karet</strong>'
                + '<span>|</span><span>str. ' + (currentPage + 1) + '/' + totalPages + '</span>'
                + '<span>|</span><span>tpl: ' + currentFilter + '</span>'
                + '<span>|</span><span>kat: ' + catLabel + '</span>'
                + '<span>|</span><span>\u0159ada: ' + lineLabel + '</span>'
                + '</div>';
            container.insertAdjacentHTML('afterbegin', countBar);

            // Stagger card entrance animations
            container.querySelectorAll('.card').forEach(function (card, idx) {
                card.style.animationDelay = (idx * 0.06) + 's';
            });

            // Stagger energy bar animations
            container.querySelectorAll('.energy-fill').forEach(function (bar, idx) {
                const baseDelay = parseFloat(bar.style.animationDelay) || 0.3;
                bar.style.animationDelay = (baseDelay + Math.floor(idx / 3) * 0.15) + 's';
            });

            // Inject per-card toolbar + controls
            container.querySelectorAll('.card').forEach(function (card, idx) {
                card.dataset.idx = start + idx;
                // Store product URL on card for the URL strip
                const productData = filtered[start + idx];
                if (productData && productData._url) card.dataset.url = productData._url;
                injectCardToolbar(card);
                // Apply current export format class
                var fmtClass = formatClassMap[currentExportFormat];
                if (fmtClass) card.classList.add(fmtClass);
            });

            // Pagination bar
            renderPagination(container, totalPages, filtered.length);

            // Update panel
            updateAssetSummary();
            const label = document.getElementById('totalProductsLabel');
            if (label) label.textContent = filtered.length + ' / ' + products.length;
            setStatus(pageItems.length + ' karet (str. ' + (currentPage + 1) + '/' + totalPages + ' z ' + filtered.length + '). v6 ASSET ready.', '#34d399');
            updateBgStats();
        }

        function updateCount() {
            const cards = document.querySelectorAll('.card');
            const bar = document.querySelector('.preview-count');
            if (bar) bar.querySelector('strong').textContent = cards.length + ' karet';
        }

        function setStatus(msg, color) {
            const el = document.getElementById('statusText');
            el.textContent = msg;
            el.style.color = color || 'var(--muted)';
        }

        // ─── v5: Load products from Heureka JSON ───
        async function loadFromCache() {
            setStatus('Načítám Heureka produktový feed...', 'var(--accent)');
            try {
                // Primary: Heureka JSON (converted from XML feed)
                let data;
                const res = await fetch('/data/heureka-products.json');
                if (res.ok) {
                    data = await res.json();
                } else {
                    // Fallback: old cache
                    const res2 = await fetch('/data/products-cache.json');
                    if (!res2.ok) throw new Error('Nelze načíst feed: HTTP ' + res2.status);
                    data = await res2.json();
                }
                const allProducts = data.products || [];
                const meta = data.meta || {};
                // Filter: must have price > 50 and image
                const viable = allProducts.filter(p => p.price && p.price > 50 && p.img);
                cachedProducts = viable;

                // Smart sort: prioritized order, but load ALL products
                const sorted = smartSelectProducts(viable, viable.length);

                // Build CSV from ALL Heureka products
                const headers = 'id;product_name;hook;price;specs;image_url;image_alt;focal_point;overlay_style;badge_stock;positioning_claim;cta;template;_category;_lineup;_gpuRaw;_stock;_url';
                const tierTemplates = {
                    budget: ['minimal', 'split', 'specs-focus'],
                    mid: ['split', 'hero', 'minimal', 'specs-focus'],
                    premium: ['hero', 'neon', 'cinema', 'specs-focus', 'split'],
                    ultra: ['cinema', 'neon', 'hero', 'specs-focus', 'split']
                };
                const tierCounters = { budget: 0, mid: 0, premium: 0, ultra: 0 };
                copyEngine.reset();

                const lines = sorted.map(p => {
                    const category = detectCategory(p);
                    const gpu = (p.specs && p.specs.gpu) ? p.specs.gpu : '';
                    const gpuInfo = detectGpuBrand(gpu);
                    const priceStr = p.priceFormatted || formatPrice(p.price);
                    const tier = copyEngine.getTier(String(p.price));
                    const copy = copyEngine.generate(String(p.price), category, p);
                    const pool = tierTemplates[tier];
                    const tpl = pool[tierCounters[tier] % pool.length];
                    tierCounters[tier]++;

                    // Build specs line from Heureka structured specs
                    const s = p.specs || {};
                    const specsLine = [s.cpu, s.gpu, s.ram].filter(x => x).join(' / ');

                    return [
                        p.id,
                        p.name || '',
                        copy.hook,
                        priceStr,
                        specsLine,
                        p.img,
                        p.name || '',
                        'center',
                        'dark',
                        p.inStock ? 'Skladem' : 'Na objednávku',
                        copy.claim,
                        copy.cta,
                        tpl,
                        category,
                        p.lineup || '',
                        gpu || '',
                        p.inStock ? '1' : '0',
                        p.url || ''
                    ].join(';');
                });

                document.getElementById('csvInput').value = headers + '\n' + lines.join('\n');
                const src = meta.source === 'heureka' ? 'Heureka feed' : 'cache';
                currentPage = 0;
                var effectiveSize = pageSize === 0 ? sorted.length : pageSize;
                setStatus('Načteno ' + sorted.length + ' produktů z ' + src + '. Stránkování: ' + effectiveSize + ' per page. Klikni Generovat!', '#34d399');
            } catch (e) {
                setStatus('Chyba: ' + e.message, '#f87171');
                console.error(e);
            }
        }

        // ─── v5: Smart Product Selection (Heureka-aware) ───
        function smartSelectProducts(products, count) {
            // Group by Heureka category slug
            const byCategory = {};
            products.forEach(p => {
                const cat = detectCategory(p);
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(p);
            });

            // Priority weights: high-margin categories get more slots
            const priorityCats = ['pc', 'gpu', 'notebook', 'cpu', 'phone', 'headset', 'monitor', 'case', 'psu', 'mobo', 'cooler', 'ram', 'storage', 'peripheral'];
            const selected = [];
            const targetRatios = { pc: 0.35, gpu: 0.12, notebook: 0.1, cpu: 0.08, phone: 0.08, headset: 0.06, monitor: 0.04 };

            // Fill priority categories first
            for (const cat of priorityCats) {
                const target = Math.max(1, Math.ceil(count * (targetRatios[cat] || 0.02)));
                const pool = byCategory[cat] || [];
                if (!pool.length) continue;
                pool.sort((a, b) => (b.price || 0) - (a.price || 0));
                const step = Math.max(1, Math.floor(pool.length / target));
                for (let i = 0; i < Math.min(target, pool.length); i++) {
                    const idx = Math.min(i * step, pool.length - 1);
                    if (!selected.find(s => s.id === pool[idx].id)) {
                        selected.push(pool[idx]);
                    }
                    if (selected.length >= count) break;
                }
                if (selected.length >= count) break;
            }

            // Fill remaining slots with highest-priced unselected from any category
            if (selected.length < count) {
                const remaining = products
                    .filter(p => !selected.find(s => s.id === p.id))
                    .sort((a, b) => (b.price || 0) - (a.price || 0));
                while (selected.length < count && remaining.length) {
                    selected.push(remaining.shift());
                }
            }

            return selected.slice(0, count);
        }



        // ─── Smart Copy: regenerate all hooks/claims/CTAs ───
        function generateSmartCopy() {
            copyEngine.reset();
            const csv = document.getElementById('csvInput').value;
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return;
            const headers = lines[0].split(';').map(h => h.trim());
            const hookIdx = headers.indexOf('hook');
            const ctaIdx = headers.indexOf('cta');
            const claimIdx = headers.indexOf('positioning_claim');
            const priceIdx = headers.indexOf('price');
            const catIdx = headers.indexOf('_category');
            const idIdx = headers.indexOf('id');

            const newLines = [lines[0]];
            for (let i = 1; i < lines.length; i++) {
                const vals = lines[i].split(';');
                const price = priceIdx >= 0 ? vals[priceIdx] : '0';
                const cat = catIdx >= 0 ? vals[catIdx] : '';
                // Find original product from cache for smart copy
                const pid = idIdx >= 0 ? vals[idIdx] : '';
                const product = cachedProducts.find(function (p) { return p.id === pid; }) || null;
                const gen = copyEngine.generate(price, cat, product);
                if (hookIdx >= 0) vals[hookIdx] = gen.hook;
                if (ctaIdx >= 0) vals[ctaIdx] = gen.cta;
                if (claimIdx >= 0) vals[claimIdx] = gen.claim;
                newLines.push(vals.join(';'));
            }
            document.getElementById('csvInput').value = newLines.join('\n');
            setStatus('Smart Copy vygenerován pro ' + String(lines.length - 1) + ' produktů.', '#34d399');
        }

        // ─── AI Background Removal (Server-side via /api/remove-bg) ───
        // No WASM, no 40MB download. Server runs onnxruntime-node natively = fast.

        function getBgStrength() {
            var slider = document.getElementById('bgStrengthSlider');
            return slider ? parseInt(slider.value) / 100 : 0.65;
        }

        // Post-process: soften BG removal based on strength slider
        // strength 1.0 = aggressive (raw model output)
        // strength 0.3 = gentle (boosts semi-transparent edge pixels → preserves more detail)
        async function applyBgStrength(blob, strength) {
            if (strength >= 0.95) return blob; // max strength = no post-processing
            return new Promise(function (resolve) {
                var img = new Image();
                img.onload = function () {
                    var c = document.createElement('canvas');
                    c.width = img.width;
                    c.height = img.height;
                    var ctx = c.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    var data = ctx.getImageData(0, 0, c.width, c.height);
                    var px = data.data;
                    // boost factor: at strength 0.3 → 1.4x alpha boost, at 0.5 → 1.0x, at 0.8 → 0.4x
                    var boost = 2 - strength * 2;
                    for (var i = 3; i < px.length; i += 4) {
                        var a = px[i];
                        if (a > 0 && a < 255) {
                            px[i] = Math.min(255, Math.round(a * (1 + boost)));
                        }
                    }
                    ctx.putImageData(data, 0, 0);
                    c.toBlob(function (b) { resolve(b); }, 'image/png');
                };
                img.src = URL.createObjectURL(blob);
            });
        }

        async function removeBackgroundViaAPI(imageSrc) {
            // If it's a blob URL or data URL, send raw bytes
            if (imageSrc.startsWith('blob:') || imageSrc.startsWith('data:')) {
                const r = await fetch(imageSrc);
                const blob = await r.blob();
                const resp = await fetch('/api/remove-bg', {
                    method: 'POST',
                    headers: { 'Content-Type': blob.type || 'image/png' },
                    body: blob
                });
                if (!resp.ok) throw new Error('API error: ' + resp.status + ' ' + (await resp.text()));
                return await resp.blob();
            }
            // External URL — let the server fetch it (no CORS issues)
            const resp = await fetch('/api/remove-bg', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: imageSrc })
            });
            if (!resp.ok) throw new Error('API error: ' + resp.status + ' ' + (await resp.text()));
            return await resp.blob();
        }

        // ─── Post-process: enhance cutout image ───
        function enhanceImage(img) {
            img.classList.add('bg-removed', 'enhanced');
        }

        // ─── Per-card BG removal (legacy compat) ───
        async function removeBgCard(img, btn) {
            if (!img) return;
            if (img.dataset.bgRemoved) {
                setStatus('Pozadí již odstraněno.', 'var(--muted)');
                return;
            }
            // Store original for undo
            img.dataset.originalSrc = img.src;
            if (btn) { btn.textContent = '⏳'; btn.style.pointerEvents = 'none'; }
            setStatus('Odstraňuji pozadí...', 'var(--accent)');
            try {
                var rawBlob = await removeBackgroundViaAPI(img.src);
                var resultBlob = await applyBgStrength(rawBlob, getBgStrength());
                img.src = URL.createObjectURL(resultBlob);
                img.dataset.bgRemoved = '1';
                enhanceImage(img);
                if (btn) { btn.textContent = '✅'; }
                // Show undo button, hide bg button in toolbar
                var card = img.closest('.card');
                if (card) {
                    var bgBtn = card.querySelector('.tb-btn.bg');
                    var undoBtn = card.querySelector('.tb-btn.undo');
                    if (bgBtn) bgBtn.style.display = 'none';
                    if (undoBtn) undoBtn.style.display = '';
                }
                showUndoAllBtn();
                setStatus('Pozadí odstraněno + obrázek vylepšen!', '#34d399');
                updateBgStats();
            } catch (e) {
                if (btn) { btn.textContent = '🖼'; btn.style.pointerEvents = ''; }
                setStatus('Chyba: ' + e.message, '#f87171');
                console.error('BG removal error:', e);
            }
        }

        // ─── v6: BG removal from toolbar button ───
        async function removeBgToolbar(tbBtn) {
            const card = tbBtn.closest('.card');
            const img = card ? card.querySelector('.product-img') : null;
            removeBgCard(img, tbBtn);
        }

        // ─── Undo BG removal per card ───
        function undoBgCard(card) {
            if (!card) return;
            var img = card.querySelector('.product-img');
            if (!img || !img.dataset.originalSrc) return;
            img.src = img.dataset.originalSrc;
            delete img.dataset.bgRemoved;
            delete img.dataset.originalSrc;
            img.classList.remove('bg-removed', 'enhanced');
            img.style.filter = '';
            // Swap toolbar buttons back
            var bgBtn = card.querySelector('.tb-btn.bg');
            var undoBtn = card.querySelector('.tb-btn.undo');
            if (bgBtn) { bgBtn.style.display = ''; bgBtn.textContent = '\uD83D\uDDBC'; bgBtn.style.pointerEvents = ''; }
            if (undoBtn) undoBtn.style.display = 'none';
            updateBgStats();
            showUndoAllBtn();
            setStatus('BG removal reverted.', '#fbbf24');
        }

        function undoBgToolbar(tbBtn) {
            var card = tbBtn.closest('.card');
            undoBgCard(card);
        }

        function undoAllBg() {
            var cards = document.querySelectorAll('.card');
            var count = 0;
            cards.forEach(function (card) {
                var img = card.querySelector('.product-img');
                if (img && img.dataset.originalSrc) {
                    undoBgCard(card);
                    count++;
                }
            });
            setStatus('Reverted ' + count + ' images to original.', '#fbbf24');
        }

        function showUndoAllBtn() {
            var btn = document.getElementById('undoAllBgBtn');
            if (!btn) return;
            var hasAny = document.querySelector('.product-img[data-original-src]');
            btn.style.display = hasAny ? '' : 'none';
        }

        // ─── Selection helpers ───
        function selectAllCards() {
            document.querySelectorAll('.card').forEach(c => c.classList.add('selected'));
            updateBgStats();
        }
        function deselectAllCards() {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            updateBgStats();
        }
        function updateBgStats() {
            const all = document.querySelectorAll('.card').length;
            const sel = document.querySelectorAll('.card.selected').length;
            const done = document.querySelectorAll('.card .product-img.bg-removed').length;
            const el = document.getElementById('bgStats');
            if (el) el.innerHTML = '<span>' + sel + ' selected</span> ・ <span style="color:#34d399">' + done + ' processed</span> ・ <span>' + all + ' total</span>';
        }

        // ─── Preload AI model (warm up the server) ───
        async function preloadModel() {
            const preloadBtn = document.getElementById('preloadModelBtn');
            if (preloadBtn) { preloadBtn.textContent = '⏳ Warming up...'; preloadBtn.style.pointerEvents = 'none'; }
            try {
                // Send a tiny 1x1 red PNG to warm up the model on the server
                const tinyPng = Uint8Array.from(atob('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=='), c => c.charCodeAt(0));
                const resp = await fetch('/api/remove-bg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/png' },
                    body: tinyPng
                });
                if (resp.ok) {
                    setStatus('AI engine zahřátý. Připraveno!', '#34d399');
                    if (preloadBtn) { preloadBtn.textContent = '✅ AI Ready'; preloadBtn.className = 'btn small success'; }
                } else {
                    throw new Error('Status ' + resp.status);
                }
            } catch (e) {
                setStatus('Preload selhal: ' + e.message, '#f87171');
                if (preloadBtn) { preloadBtn.textContent = '⚡ Preload AI'; preloadBtn.style.pointerEvents = ''; }
            }
        }

        // ─── Batch BG removal: process SELECTED cards with progress ───
        async function removeBackgroundSelected() {
            const selectedCards = Array.from(document.querySelectorAll('.card.selected'));
            const unprocessed = selectedCards.filter(c => {
                const img = c.querySelector('.product-img');
                return img && !img.dataset.bgRemoved;
            });
            if (!selectedCards.length) {
                setStatus('Nejdřív vyber karty kliknutím. Pak klikni Remove BG.', '#f87171');
                return;
            }
            if (!unprocessed.length) {
                setStatus('Všechny vybrané obrázky již zpracovány.', 'var(--muted)');
                return;
            }

            let done = 0;
            let failed = 0;
            const total = unprocessed.length;
            const progressEl = document.getElementById('bgProgress');
            const startTime = Date.now();
            function updateProgress() {
                const pct = Math.round((done / total) * 100);
                const elapsed = (Date.now() - startTime) / 1000;
                const perItem = done > 0 ? elapsed / done : 0;
                const remaining = Math.round(perItem * (total - done));
                const eta = done > 0 && done < total ? ' ・ ~' + remaining + 's left' : '';
                progressEl.innerHTML = '<div class="bg-progress"><span>' + done + '/' + total + (failed ? ' (' + failed + ' err)' : '') + '</span>'
                    + '<div class="bar"><div class="bar-fill" style="width:' + pct + '%"></div></div>'
                    + '<span>' + pct + '%' + eta + '</span></div>';
                setStatus('BG removal: ' + done + '/' + total + '...' + eta, 'var(--accent)');
            }
            updateProgress();

            var strength = getBgStrength();
            for (const card of unprocessed) {
                const img = card.querySelector('.product-img');
                const btn = card.querySelector('.tb-btn.bg') || card.querySelector('.bg-btn');
                if (btn) { btn.textContent = '⏳'; btn.style.pointerEvents = 'none'; }
                // Store original for undo
                img.dataset.originalSrc = img.src;
                try {
                    var rawBlob = await removeBackgroundViaAPI(img.src);
                    var resultBlob = await applyBgStrength(rawBlob, strength);
                    img.src = URL.createObjectURL(resultBlob);
                    img.dataset.bgRemoved = '1';
                    enhanceImage(img);
                    if (btn) { btn.textContent = '✅'; }
                    // Show undo, hide bg button
                    var bgBtn = card.querySelector('.tb-btn.bg');
                    var undoBtn = card.querySelector('.tb-btn.undo');
                    if (bgBtn) bgBtn.style.display = 'none';
                    if (undoBtn) undoBtn.style.display = '';
                    done++;
                } catch (e) {
                    if (btn) { btn.textContent = '🖼'; btn.style.pointerEvents = ''; }
                    delete img.dataset.originalSrc;
                    console.error('BG fail:', e);
                    failed++;
                    done++;
                }
                updateProgress();
                updateBgStats();
            }
            showUndoAllBtn();
            progressEl.innerHTML = '';
            const successCount = total - failed;
            setStatus('Hotovo: ' + successCount + '/' + total + ' obrázků zpracováno a vylepšeno.' + (failed ? ' (' + failed + ' chyb)' : ' ✅'), '#34d399');
        }

        // ─── v6: Save individual card as PNG ───
        async function saveCardAsPNG(card) {
            if (typeof html2canvas === 'undefined') {
                setStatus('Načítám export engine...', 'var(--accent)');
                await new Promise(function (resolve, reject) {
                    const s = document.createElement('script');
                    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    s.onload = resolve; s.onerror = reject;
                    document.head.appendChild(s);
                });
            }
            var hideEls = [card.querySelector('.card-toolbar'), card.querySelector('.select-check'), card.querySelector('.saved-badge'), card.querySelector('.product-url'), card.querySelector('.tpl-switcher')];
            hideEls.forEach(function (el) { if (el) el.style.display = 'none'; });
            card.style.animation = 'none';
            card.querySelectorAll('*').forEach(function (el) { el.style.animation = 'none'; });
            var saveBtn = card.querySelector('.tb-btn.save');
            if (saveBtn) saveBtn.textContent = '⏳';
            try {
                var canvas = await html2canvas(card, { scale: 2, useCORS: true, backgroundColor: null, logging: false });
                var productName = (card.querySelector('.name') ? card.querySelector('.name').textContent : 'card');
                var safeName = productName.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 40);
                var link = document.createElement('a');
                link.download = 'hellocomp-' + (card.dataset.tpl || 'post') + '-' + safeName + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                card.classList.add('is-saved');
                if (saveBtn) { saveBtn.textContent = '✅'; saveBtn.classList.add('saved-ok'); }
                setStatus('💾 Uloženo: ' + link.download, '#34d399');
            } catch (e) {
                setStatus('Export chyba: ' + e.message, '#f87171');
                if (saveBtn) saveBtn.textContent = '💾';
            }
            hideEls.forEach(function (el) { if (el) el.style.display = ''; });
            updateAssetSummary();
        }

        // ─── v6: Toggle inline edit mode on card ───
        function toggleEditMode(card) {
            var isEditing = card.classList.toggle('editing');
            var editables = card.querySelectorAll('.hook, .name, .price, .cta-btn, .claim, .specs-line, .cta-url');
            editables.forEach(function (el) { el.contentEditable = isEditing ? 'true' : 'false'; });
            var editBtn = card.querySelector('.tb-btn.edit');
            if (editBtn) editBtn.textContent = isEditing ? '✅' : '✏️';
            if (isEditing) {
                setStatus('✏️ Edit mode: klikni na text pro úpravu. Klikni ✅ Done pro uložení.', 'var(--accent)');
            } else {
                card.classList.add('was-edited');
                setStatus('✅ Úpravy uloženy na kartě.', '#34d399');
                updateAssetSummary();
            }
        }

        // ─── v6: Lightbox (fullscreen preview) ───
        function openLightbox(card) {
            var lb = document.getElementById('lightbox');
            var content = document.getElementById('lbContent');
            content.innerHTML = '';
            var clone = card.cloneNode(true);
            clone.style.animation = 'none';
            clone.querySelectorAll('*').forEach(function (el) { el.style.animation = 'none'; });
            content.appendChild(clone);
            lb.classList.add('open');
            lb.dataset.sourceIdx = card.dataset.idx || '';
        }

        function closeLightbox() {
            var lb = document.getElementById('lightbox');
            lb.classList.remove('open');
            document.getElementById('lbContent').innerHTML = '';
        }

        async function saveLightboxCard() {
            var idx = document.getElementById('lightbox').dataset.sourceIdx;
            var original = idx ? document.querySelector('.card[data-idx="' + idx + '"]') : null;
            if (original) {
                closeLightbox();
                await saveCardAsPNG(original);
            } else {
                setStatus('Karta nenalezena.', '#f87171');
            }
        }

        // ─── v6: Pagination navigation ───
        function navigatePage(page) {
            currentPage = page;
            renderCards();
            document.getElementById('cardsContainer').scrollTop = 0;
        }

        // ─── v6: Asset summary update ───
        function updateAssetSummary() {
            var cards = document.querySelectorAll('#cardsContainer .card');
            var saved = document.querySelectorAll('#cardsContainer .card.is-saved');
            var edited = document.querySelectorAll('#cardsContainer .card.was-edited');
            var el = document.getElementById('asTotal');
            if (el) el.textContent = lastFilteredCount;
            var se = document.getElementById('asSaved');
            if (se) se.textContent = saved.length;
            var ee = document.getElementById('asEdited');
            if (ee) ee.textContent = edited.length;
        }

        // ─── v7: Per-card template switching ───
        function switchCardTemplate(card, newTpl) {
            if (!templates[newTpl]) return;
            // Extract product data from card's data attrs and DOM
            const csv = document.getElementById('csvInput').value;
            const products = parseCSV(csv);
            const idx = parseInt(card.dataset.idx);
            if (isNaN(idx) || !products[idx]) return;
            const p = products[idx];
            p._resolvedTpl = newTpl;
            // Remember state
            const wasSelected = card.classList.contains('selected');
            const wasSaved = card.classList.contains('is-saved');
            const wasEdited = card.classList.contains('was-edited');
            const bgRemoved = card.querySelector('.product-img.bg-removed');
            const bgSrc = bgRemoved ? bgRemoved.src : null;
            // Generate new HTML
            const html = templates[newTpl](p);
            const temp = document.createElement('div');
            temp.innerHTML = html;
            const newCard = temp.firstElementChild;
            // Preserve state
            newCard.dataset.idx = idx;
            if (p._url) newCard.dataset.url = p._url;
            if (wasSelected) newCard.classList.add('selected');
            if (wasSaved) newCard.classList.add('is-saved');
            if (wasEdited) newCard.classList.add('was-edited');
            // Replace in DOM
            card.parentNode.replaceChild(newCard, card);
            // Restore BG-removed image if applicable
            if (bgSrc) {
                const newImg = newCard.querySelector('.product-img');
                if (newImg) { newImg.src = bgSrc; newImg.dataset.bgRemoved = '1'; enhanceImage(newImg); }
            }
            // Re-inject toolbar with template switcher
            injectCardToolbar(newCard);
            // Highlight active template in switcher
            newCard.querySelectorAll('.ts-btn').forEach(function (b) {
                b.classList.toggle('active', b.dataset.tpl === newTpl);
            });
        }

        // ─── v7: Sort products in CSV ───
        let currentSort = 'price-desc';
        function sortProducts() {
            const csv = document.getElementById('csvInput').value;
            const lines = csv.trim().split('\n').filter(l => l.trim());
            if (lines.length < 2) return;
            const headers = lines[0];
            const hArr = headers.split(';').map(h => h.trim());
            const priceIdx = hArr.indexOf('price');
            const nameIdx = hArr.indexOf('product_name');
            const catIdx = hArr.indexOf('_category');
            const dataLines = lines.slice(1);
            dataLines.sort(function (a, b) {
                const va = a.split(';');
                const vb = b.split(';');
                switch (currentSort) {
                    case 'price-desc': {
                        const pa = parseInt(String(va[priceIdx] || '0').replace(/[^\d]/g, '')) || 0;
                        const pb = parseInt(String(vb[priceIdx] || '0').replace(/[^\d]/g, '')) || 0;
                        return pb - pa;
                    }
                    case 'price-asc': {
                        const pa = parseInt(String(va[priceIdx] || '0').replace(/[^\d]/g, '')) || 0;
                        const pb = parseInt(String(vb[priceIdx] || '0').replace(/[^\d]/g, '')) || 0;
                        return pa - pb;
                    }
                    case 'name-asc':
                        return (va[nameIdx] || '').localeCompare(vb[nameIdx] || '', 'cs');
                    case 'name-desc':
                        return (vb[nameIdx] || '').localeCompare(va[nameIdx] || '', 'cs');
                    case 'category':
                        return (va[catIdx] || '').localeCompare(vb[catIdx] || '', 'cs') || (parseInt(String(vb[priceIdx] || '0').replace(/[^\d]/g, '')) || 0) - (parseInt(String(va[priceIdx] || '0').replace(/[^\d]/g, '')) || 0);
                    default:
                        return 0;
                }
            });
            document.getElementById('csvInput').value = headers + '\n' + dataLines.join('\n');
            currentPage = 0;
            renderCards();
        }

        // ─── v7: Export format / dimensions ───
        let currentExportFormat = '1080x1920';
        var formatClassMap = {
            '1080x1920': '',
            '1080x1080': 'fmt-square',
            '1200x628': 'fmt-fb',
            '1920x1080': 'fmt-wide'
        };

        function setExportFormat(format) {
            currentExportFormat = format;
            document.querySelectorAll('#exportPicker .ep-btn').forEach(function (b) {
                b.classList.toggle('active', b.dataset.format === format);
            });
            // Sync modal format selector
            document.querySelectorAll('#vexFormatGroup .vex-opt').forEach(function (b) {
                b.classList.toggle('active', b.dataset.vfmt === format);
            });
            // Apply format class + dimensions to cards
            var fmtClass = formatClassMap[format] || '';
            var container = document.getElementById('cardsContainer');
            container.querySelectorAll('.card').forEach(function (card) {
                // Remove all format classes
                card.classList.remove('fmt-square', 'fmt-fb', 'fmt-wide');
                card.style.removeProperty('aspect-ratio');
                card.style.removeProperty('width');
                if (fmtClass) card.classList.add(fmtClass);
            });
            // Update footer stats in modal
            updateVexStats();
            var dims = format.split('x');
            setStatus('Export formát: ' + format + ' (' + dims[0] + '×' + dims[1] + ')', '#34d399');
        }

        // ─── Card selection (click to toggle) ───
        document.getElementById('cardsContainer').addEventListener('click', function (e) {
            if (e.target.closest('.card-toolbar') || e.target.closest('.remove-btn') || e.target.closest('.cta-btn')) return;
            var card = e.target.closest('.card');
            if (!card || card.classList.contains('editing')) return;
            card.classList.toggle('selected');
            updateBgStats();
        });

        // ─── Card double-click → lightbox ───
        document.getElementById('cardsContainer').addEventListener('dblclick', function (e) {
            if (e.target.closest('.card-toolbar')) return;
            var card = e.target.closest('.card');
            if (!card || card.classList.contains('editing')) return;
            openLightbox(card);
        });

        // ─── Template filter chips ───
        document.getElementById('templateChips').addEventListener('click', function (e) {
            if (!e.target.classList.contains('chip')) return;
            this.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.tpl;
            currentPage = 0;
            renderCards();
        });

        // ─── v5: Category filter chips ───
        document.getElementById('categoryChips').addEventListener('click', function (e) {
            if (!e.target.classList.contains('chip')) return;
            this.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentCategory = e.target.dataset.cat;
            currentPage = 0;
            renderCards();
        });

        // ─── v5: Lineup filter chips ───
        document.getElementById('lineupChips').addEventListener('click', function (e) {
            if (!e.target.classList.contains('chip')) return;
            this.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentLineup = e.target.dataset.lineup;
            currentPage = 0;
            renderCards();
        });

        // ─── Button bindings ───
        document.getElementById('renderBtn').addEventListener('click', async function () {
            // Auto-load Heureka data if CSV is empty or has old hardcoded data
            const csv = document.getElementById('csvInput').value.trim();
            if (!csv || csv.split('\n').length < 3) {
                await loadFromCache();
            }
            renderCards();
        });
        document.getElementById('clearBtn').addEventListener('click', function () {
            document.getElementById('cardsContainer').innerHTML = '';
            setStatus('Vyčištěno.', 'var(--muted)');
        });
        document.getElementById('loadCacheBtn').addEventListener('click', loadFromCache);
        document.getElementById('generateCopyBtn').addEventListener('click', function () {
            generateSmartCopy();
            renderCards();
        });
        document.getElementById('removeBgSelectedBtn').addEventListener('click', removeBackgroundSelected);
        document.getElementById('selectAllCardsBtn').addEventListener('click', selectAllCards);
        document.getElementById('deselectAllBtn').addEventListener('click', deselectAllCards);
        document.getElementById('preloadModelBtn').addEventListener('click', preloadModel);
        document.getElementById('undoAllBgBtn').addEventListener('click', undoAllBg);
        // Strength slider label update
        var bgSlider = document.getElementById('bgStrengthSlider');
        var bgSliderVal = document.getElementById('bgStrengthVal');
        bgSlider.addEventListener('input', function () { bgSliderVal.textContent = this.value + '%'; });
        document.getElementById('exportBtn').addEventListener('click', exportCards);
        document.getElementById('recordVideoBtn').addEventListener('click', recordSelectedVideo);
        document.getElementById('pageSizeSelect').addEventListener('change', function () {
            pageSize = parseInt(this.value) || 0;
            currentPage = 0;
            renderCards();
        });
        // v7: Sort handler
        document.getElementById('sortSelect').addEventListener('change', function () {
            currentSort = this.value;
            sortProducts();
        });
        // v7: Export format picker
        document.getElementById('exportPicker').addEventListener('click', function (e) {
            var btn = e.target.closest('.ep-btn');
            if (!btn) return;
            setExportFormat(btn.dataset.format);
        });
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeLightbox();
        });

        // ─── PNG Export All (html2canvas) ───
        async function exportCards() {
            var cards = document.querySelectorAll('.card');
            if (!cards.length) { setStatus('Nejdřív vygeneruj karty.', '#f87171'); return; }

            if (typeof html2canvas === 'undefined') {
                setStatus('Načítám export engine...', 'var(--accent)');
                await new Promise(function (resolve, reject) {
                    var s = document.createElement('script');
                    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    s.onload = resolve;
                    s.onerror = reject;
                    document.head.appendChild(s);
                });
            }

            setStatus('Exportuji ' + cards.length + ' karet jako PNG...', 'var(--accent)');
            var done = 0;

            for (var ci = 0; ci < cards.length; ci++) {
                var card = cards[ci];
                try {
                    var hideEls = [card.querySelector('.card-toolbar'), card.querySelector('.select-check'), card.querySelector('.saved-badge'), card.querySelector('.product-url'), card.querySelector('.tpl-switcher')];
                    hideEls.forEach(function (el) { if (el) el.style.display = 'none'; });
                    card.style.animation = 'none';
                    card.querySelectorAll('*').forEach(function (el) { el.style.animation = 'none'; });

                    var canvas = await html2canvas(card, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: null,
                        logging: false
                    });

                    hideEls.forEach(function (el) { if (el) el.style.display = ''; });

                    var link = document.createElement('a');
                    link.download = 'hellocomp-' + (card.dataset.tpl || 'card') + '-' + currentExportFormat + '-' + (done + 1) + '.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    card.classList.add('is-saved');
                    done++;
                    setStatus('Export: ' + done + '/' + cards.length + '...', 'var(--accent)');
                } catch (e) {
                    console.error('Export error:', e);
                }
            }

            updateAssetSummary();
            setStatus('Exportováno ' + done + ' karet jako PNG!', '#34d399');
        }

        // ═══════════════════════════════════════════════════════════
        // 🎬 PRO VIDEO EXPORT — Cinematic 15s Reveal + MP4/WebM
        // Uses WebCodecs API + mp4-muxer for MP4 (Chrome/Edge)
        // Falls back to MediaRecorder WebM for Safari/Firefox
        // ═══════════════════════════════════════════════════════════

        // Easing functions for cinematic motion
        function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
        function easeInOutQuart(t) { return t < .5 ? 8 * t * t * t * t : 1 - Math.pow(-2 * t + 2, 4) / 2; }
        function easeOutBack(t) { var c1 = 1.70158, c3 = c1 + 1; return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2); }

        /**
         * Render a cinematic frame onto a canvas context.
         * t = progress 0..1 over 15 seconds
         * snapshotImg = html2canvas rendered image of the card
         */
        function drawCinematicFrame(ctx, w, h, t, snapshotImg) {
            // Clear
            ctx.clearRect(0, 0, w, h);

            // Phase timeline (15s):
            // 0-0.1  (0-1.5s): Black with subtle particles fade-in
            // 0.1-0.35 (1.5-5.25s): Product reveal — zoom from large to normal with blur clear
            // 0.35-0.55 (5.25-8.25s): Full card visible, gaming VFX burst
            // 0.55-0.85 (8.25-12.75s): Hold with ambient effects
            // 0.85-1.0 (12.75-15s): Final glamour hold with subtle pulse

            // === BACKGROUND ===
            // Dark cinematic bg with gradient
            var grad = ctx.createLinearGradient(0, 0, 0, h);
            grad.addColorStop(0, '#050810');
            grad.addColorStop(0.5, '#0a0e1a');
            grad.addColorStop(1, '#050810');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);

            // === PHASE 1: Black intro with particles ===
            if (t < 0.1) {
                var introAlpha = easeOutCubic(t / 0.1);
                // Draw subtle floating particles
                drawGamingParticles(ctx, w, h, t, introAlpha * 0.3);
                // Draw cinematic letterbox bars
                drawLetterbox(ctx, w, h, 1);
                return;
            }

            // === PHASE 2: Product reveal ===
            var revealT = 0;
            if (t >= 0.1 && t < 0.35) {
                revealT = easeOutBack((t - 0.1) / 0.25);
            } else {
                revealT = 1;
            }

            // Card scale: starts at 1.4x zoomed in, settles to 1x
            var cardScale = 1.4 - 0.4 * revealT;
            // Card opacity: fades in
            var cardAlpha = Math.min(1, revealT * 1.5);
            // Card blur: starts blurry
            var shouldBlur = t < 0.2;

            // Draw gaming VFX behind card
            if (t >= 0.1) {
                var vfxIntensity = t < 0.35 ? easeOutCubic((t - 0.1) / 0.25) * 0.5 : 1;
                drawGamingVFX(ctx, w, h, t, vfxIntensity);
            }

            // === Draw the card snapshot ===
            ctx.save();
            ctx.globalAlpha = cardAlpha;
            ctx.translate(w / 2, h / 2);
            ctx.scale(cardScale, cardScale);

            if (snapshotImg) {
                // Center the snapshot
                var imgW = snapshotImg.width;
                var imgH = snapshotImg.height;
                var fitScale = Math.min(w / imgW, h / imgH) * 0.95;
                ctx.drawImage(snapshotImg, -imgW * fitScale / 2, -imgH * fitScale / 2, imgW * fitScale, imgH * fitScale);
            }
            ctx.restore();

            // === PHASE 3: Gaming VFX burst ===
            if (t >= 0.35 && t < 0.55) {
                var burstT = (t - 0.35) / 0.2;
                drawVFXBurst(ctx, w, h, burstT);
            }

            // === Floating particles always ===
            var particleAlpha = t < 0.1 ? t / 0.1 * 0.3 : (t < 0.35 ? 0.3 + (t - 0.1) / 0.25 * 0.5 : 0.8);
            drawGamingParticles(ctx, w, h, t, particleAlpha);

            // === Light sweep ===
            if (t >= 0.25) {
                drawLightSweep(ctx, w, h, t);
            }

            // === Scanlines ===
            drawScanlines(ctx, w, h, 0.04);

            // === Letterbox bars ===
            var barSize = t < 0.1 ? 1 : (t < 0.35 ? 1 - (t - 0.1) / 0.25 * 0.4 : 0.6);
            drawLetterbox(ctx, w, h, barSize);

            // === Brand watermark ===
            if (t >= 0.3) {
                var wmAlpha = Math.min(1, (t - 0.3) / 0.15);
                ctx.globalAlpha = wmAlpha * 0.7;
                ctx.font = 'bold ' + Math.round(h * 0.018) + 'px Inter, sans-serif';
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.textAlign = 'right';
                ctx.fillText('hellocomp.cz', w - w * 0.04, h - h * 0.03);
                ctx.globalAlpha = 1;
            }

            // === REC indicator ===
            if (t >= 0.05) {
                var recAlpha = (Math.sin(t * 8) + 1) / 2;
                ctx.globalAlpha = recAlpha * 0.8;
                ctx.fillStyle = '#ff3b3b';
                ctx.beginPath();
                ctx.arc(w * 0.94, h * 0.04, h * 0.008, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = 'bold ' + Math.round(h * 0.014) + 'px Inter, sans-serif';
                ctx.fillStyle = '#ff3b3b';
                ctx.textAlign = 'left';
                ctx.fillText('REC', w * 0.94 + h * 0.015, h * 0.04 + h * 0.005);
                ctx.globalAlpha = 1;
            }
        }

        function drawGamingParticles(ctx, w, h, t, alpha) {
            ctx.save();
            ctx.globalAlpha = alpha;
            var seed = 42;
            for (var i = 0; i < 30; i++) {
                seed = (seed * 16807 + i * 131) % 2147483647;
                var px = (seed % 1000) / 1000 * w;
                seed = (seed * 16807) % 2147483647;
                var baseY = (seed % 1000) / 1000 * h;
                var speed = 0.3 + (seed % 100) / 100 * 0.7;
                var py = (baseY - t * speed * h * 2) % (h * 1.2);
                if (py < 0) py += h * 1.2;
                seed = (seed * 16807) % 2147483647;
                var size = 1 + (seed % 100) / 100 * 3;
                var colors = ['rgba(0,212,255,.6)', 'rgba(33,102,204,.5)', 'rgba(168,85,247,.4)', 'rgba(255,255,255,.3)'];
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                ctx.arc(px, py, size, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }

        function drawGamingVFX(ctx, w, h, t, intensity) {
            ctx.save();
            ctx.globalAlpha = intensity * 0.15;
            // Radial glow behind center
            var grd = ctx.createRadialGradient(w / 2, h * 0.35, 0, w / 2, h * 0.35, w * 0.5);
            grd.addColorStop(0, 'rgba(0,212,255,.3)');
            grd.addColorStop(0.4, 'rgba(33,102,204,.15)');
            grd.addColorStop(0.7, 'rgba(168,85,247,.05)');
            grd.addColorStop(1, 'transparent');
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, w, h);

            // Rotating light rays
            ctx.globalAlpha = intensity * 0.06;
            ctx.translate(w / 2, h * 0.35);
            ctx.rotate(t * 0.5);
            for (var r = 0; r < 8; r++) {
                ctx.rotate(Math.PI / 4);
                var rGrad = ctx.createLinearGradient(0, 0, w * 0.6, 0);
                rGrad.addColorStop(0, 'rgba(0,212,255,.3)');
                rGrad.addColorStop(1, 'transparent');
                ctx.fillStyle = rGrad;
                ctx.fillRect(0, -2, w * 0.6, 4);
            }
            ctx.restore();
        }

        function drawVFXBurst(ctx, w, h, burstT) {
            ctx.save();
            // Expanding ring
            var ringRadius = easeOutCubic(burstT) * w * 0.6;
            var ringAlpha = (1 - burstT) * 0.3;
            ctx.globalAlpha = ringAlpha;
            ctx.strokeStyle = 'rgba(0,212,255,.6)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(w / 2, h * 0.4, ringRadius, 0, Math.PI * 2);
            ctx.stroke();

            // Secondary ring
            var ring2 = easeOutCubic(Math.max(0, burstT - 0.1) / 0.9) * w * 0.45;
            ctx.globalAlpha = ringAlpha * 0.5;
            ctx.strokeStyle = 'rgba(168,85,247,.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(w / 2, h * 0.4, ring2, 0, Math.PI * 2);
            ctx.stroke();

            // Flash
            if (burstT < 0.15) {
                ctx.globalAlpha = (1 - burstT / 0.15) * 0.15;
                ctx.fillStyle = '#fff';
                ctx.fillRect(0, 0, w, h);
            }
            ctx.restore();
        }

        function drawLightSweep(ctx, w, h, t) {
            ctx.save();
            var sweepT = ((t - 0.25) * 0.4) % 1;
            var sweepX = -w * 0.3 + sweepT * w * 1.6;
            var grad = ctx.createLinearGradient(sweepX - w * 0.1, 0, sweepX + w * 0.1, 0);
            grad.addColorStop(0, 'transparent');
            grad.addColorStop(0.4, 'rgba(255,255,255,.03)');
            grad.addColorStop(0.5, 'rgba(255,255,255,.06)');
            grad.addColorStop(0.6, 'rgba(255,255,255,.03)');
            grad.addColorStop(1, 'transparent');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);
            ctx.restore();
        }

        function drawScanlines(ctx, w, h, alpha) {
            ctx.save();
            ctx.globalAlpha = alpha;
            for (var y = 0; y < h; y += 4) {
                ctx.fillStyle = 'rgba(0,0,0,.15)';
                ctx.fillRect(0, y, w, 1);
            }
            ctx.restore();
        }

        function drawLetterbox(ctx, w, h, size) {
            var barH = h * 0.08 * size;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, barH);
            ctx.fillRect(0, h - barH, w, barH);
        }

        // Load mp4-muxer dynamically  (open-source: https://github.com/Vanilagy/mp4-muxer)
        var mp4MuxerLoaded = false;
        async function loadMp4Muxer() {
            if (mp4MuxerLoaded) return true;
            try {
                // Try to load mp4-muxer via dynamic ESM import
                var mod = await import('https://cdn.jsdelivr.net/npm/mp4-muxer@5.1.3/build/mp4-muxer.mjs');
                window.Mp4Muxer = mod;
                mp4MuxerLoaded = true;
                return true;
            } catch (e) {
                console.warn('mp4-muxer load failed, using WebM fallback:', e);
                return false;
            }
        }

        /**
         * Professional video export with cinematic reveal animation.
         * Tries WebCodecs + mp4-muxer for MP4 output.
         * Falls back to canvas captureStream + MediaRecorder for WebM.
         */
        async function recordCardVideo(card, durationSec) {
            durationSec = durationSec || 15;
            var fps = 30;
            var totalFrames = durationSec * fps;
            var scale = 2;

            // Ensure html2canvas is loaded
            if (typeof html2canvas === 'undefined') {
                setStatus('Loading export engine...', 'var(--accent)');
                await new Promise(function (resolve, reject) {
                    var s = document.createElement('script');
                    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    s.onload = resolve; s.onerror = reject;
                    document.head.appendChild(s);
                });
            }

            setStatus('🎬 Preparing cinematic export...', 'var(--accent)');

            // Enable hover state & animations on the card for snapshot
            card.classList.add('recording-active');
            card.dispatchEvent(new MouseEvent('mouseenter'));
            // Wait for CSS transitions to activate (0.5s delay + 0.3s transition)
            await new Promise(r => setTimeout(r, 1000));

            // Hide UI overlays
            var hideEls = [card.querySelector('.card-toolbar'), card.querySelector('.select-check'), card.querySelector('.saved-badge'), card.querySelector('.product-url'), card.querySelector('.tpl-switcher')];
            hideEls.forEach(function (el) { if (el) el.style.display = 'none'; });

            // Show REC indicator for cinema template
            var recEl = card.querySelector('.cinema-rec');
            if (recEl) recEl.classList.add('active');

            // Take a hi-res snapshot of the card with animations active
            var snapshot = await html2canvas(card, { scale: scale, useCORS: true, backgroundColor: null, logging: false });

            var cw = card.offsetWidth * scale;
            var ch = card.offsetHeight * scale;

            // Try MP4 export via WebCodecs + mp4-muxer
            var useMP4 = ('VideoEncoder' in window) && await loadMp4Muxer();

            if (useMP4) {
                await exportMP4(card, snapshot, cw, ch, fps, totalFrames, durationSec, hideEls, recEl);
            } else {
                await exportWebM(card, snapshot, cw, ch, fps, totalFrames, durationSec, hideEls, recEl);
            }
        }

        async function exportMP4(card, snapshot, cw, ch, fps, totalFrames, durationSec, hideEls, recEl) {
            setStatus('🎬 Encoding MP4 (WebCodecs + mp4-muxer)...', 'var(--accent)');

            var Muxer = window.Mp4Muxer.Muxer;
            var muxer = new Muxer({
                target: new window.Mp4Muxer.ArrayBufferTarget(),
                video: {
                    codec: 'avc',
                    width: cw,
                    height: ch
                },
                fastStart: 'in-memory'
            });

            var frameIndex = 0;
            var encodeDone = false;

            var encoder = new VideoEncoder({
                output: function (chunk, meta) {
                    muxer.addVideoChunk(chunk, meta);
                },
                error: function (e) { console.error('VideoEncoder error:', e); }
            });

            encoder.configure({
                codec: 'avc1.640028',
                width: cw,
                height: ch,
                bitrate: 12000000,
                framerate: fps,
                hardwareAcceleration: 'prefer-hardware'
            });

            // Render frames
            var offscreen = new OffscreenCanvas(cw, ch);
            var offCtx = offscreen.getContext('2d');

            for (var i = 0; i < totalFrames; i++) {
                var t = i / totalFrames;
                drawCinematicFrame(offCtx, cw, ch, t, snapshot);

                var frame = new VideoFrame(offscreen, {
                    timestamp: i * (1000000 / fps),
                    duration: 1000000 / fps
                });
                encoder.encode(frame, { keyFrame: i % (fps * 2) === 0 });
                frame.close();

                // Update progress every 10 frames
                if (i % 10 === 0) {
                    var pct = Math.round((i / totalFrames) * 100);
                    setStatus('🎬 Encoding MP4: ' + pct + '% (' + i + '/' + totalFrames + ')', 'var(--accent)');
                    await new Promise(r => setTimeout(r, 0)); // yield to UI
                }
            }

            await encoder.flush();
            encoder.close();
            muxer.finalize();

            var buffer = muxer.target.buffer;
            var blob = new Blob([buffer], { type: 'video/mp4' });

            // Cleanup
            hideEls.forEach(function (el) { if (el) el.style.display = ''; });
            if (recEl) recEl.classList.remove('active');
            card.classList.remove('recording-active');

            // Download
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'hellocomp-' + (card.dataset.tpl || 'card') + '-' + currentExportFormat + '-cinematic.mp4';
            a.click();
            URL.revokeObjectURL(url);

            setStatus('🎬 MP4 exported! (' + (blob.size / 1024 / 1024).toFixed(1) + ' MB) — ' + durationSec + 's cinematic', '#34d399');
        }

        async function exportWebM(card, snapshot, cw, ch, fps, totalFrames, durationSec, hideEls, recEl) {
            setStatus('🎬 Recording WebM (cinematic ' + durationSec + 's)...', 'var(--accent)');

            var recCanvas = document.createElement('canvas');
            recCanvas.width = cw;
            recCanvas.height = ch;
            var recCtx = recCanvas.getContext('2d');

            var stream = recCanvas.captureStream(fps);
            var mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
                ? 'video/webm;codecs=vp9'
                : 'video/webm;codecs=vp8';
            var recorder = new MediaRecorder(stream, {
                mimeType: mimeType,
                videoBitsPerSecond: 10000000
            });
            var chunks = [];
            recorder.ondataavailable = function (e) { if (e.data.size > 0) chunks.push(e.data); };

            return new Promise(function (resolve) {
                recorder.onstop = function () {
                    hideEls.forEach(function (el) { if (el) el.style.display = ''; });
                    if (recEl) recEl.classList.remove('active');
                    card.classList.remove('recording-active');

                    var blob = new Blob(chunks, { type: 'video/webm' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'hellocomp-' + (card.dataset.tpl || 'card') + '-' + currentExportFormat + '-cinematic.webm';
                    a.click();
                    URL.revokeObjectURL(url);
                    setStatus('🎬 WebM exported! (' + (blob.size / 1024 / 1024).toFixed(1) + ' MB) — ' + durationSec + 's cinematic', '#34d399');
                    resolve();
                };

                recorder.start();
                var frameCount = 0;

                function renderFrame() {
                    if (frameCount >= totalFrames) {
                        recorder.stop();
                        return;
                    }
                    var t = frameCount / totalFrames;
                    drawCinematicFrame(recCtx, cw, ch, t, snapshot);
                    frameCount++;
                    if (frameCount % 10 === 0) {
                        var pct = Math.round((frameCount / totalFrames) * 100);
                        setStatus('🎬 Recording: ' + pct + '%', 'var(--accent)');
                    }
                    requestAnimationFrame(renderFrame);
                }
                renderFrame();
            });
        }

        async function recordSelectedVideo() {
            // Open the video export modal instead of direct recording
            openVex();
        }

        // ═══════════════════════════════════════════════════════
        //   VIDEO EXPORT MODAL (VEX) — Full control studio
        // ═══════════════════════════════════════════════════════

        var vexState = {
            format: '1080x1920',
            duration: 15,
            bitrate: 12000000,
            output: 'mp4',
            rendering: false
        };

        function openVex() {
            var selected = document.querySelector('.card.selected') || document.querySelector('.card');
            if (!selected) { setStatus('No card to export — render cards first.', '#f87171'); return; }

            var overlay = document.getElementById('vexOverlay');
            overlay.classList.add('open');

            // Sync format with current export format
            vexState.format = currentExportFormat;
            document.querySelectorAll('#vexFormatGroup .vex-opt').forEach(function (b) {
                b.classList.toggle('active', b.dataset.vfmt === currentExportFormat);
            });

            // Show card preview
            var preview = document.getElementById('vexPreview');
            var empty = document.getElementById('vexPreviewEmpty');
            if (empty) empty.style.display = 'none';

            // Clone card for preview
            var existingClone = preview.querySelector('.card');
            if (existingClone) existingClone.remove();
            var clone = selected.cloneNode(true);
            clone.classList.remove('selected');
            clone.classList.add('recording-active');
            // Hide toolbar overlays
            var hideItems = clone.querySelectorAll('.card-toolbar, .select-check, .saved-badge, .product-url, .tpl-switcher');
            hideItems.forEach(function (el) { el.style.display = 'none'; });
            preview.appendChild(clone);

            updateVexStats();
        }

        function closeVex() {
            if (vexState.rendering) return; // Don't close while rendering
            document.getElementById('vexOverlay').classList.remove('open');
            // Clean up preview
            var preview = document.getElementById('vexPreview');
            var card = preview.querySelector('.card');
            if (card) card.remove();
            var empty = document.getElementById('vexPreviewEmpty');
            if (empty) empty.style.display = '';
        }

        function updateVexStats() {
            var dims = vexState.format.split('x');
            var w = parseInt(dims[0]) * 2; // 2x render scale
            var h = parseInt(dims[1]) * 2;
            var frames = vexState.duration * 30;
            var estMB = ((vexState.bitrate * vexState.duration) / 8 / 1024 / 1024).toFixed(0);

            var resEl = document.getElementById('vexResVal');
            var framesEl = document.getElementById('vexFramesVal');
            var sizeEl = document.getElementById('vexSizeVal');
            if (resEl) resEl.textContent = w + '×' + h;
            if (framesEl) framesEl.textContent = frames;
            if (sizeEl) sizeEl.textContent = '~' + estMB + ' MB';
        }

        // Wire up modal button groups
        document.getElementById('vexFormatGroup').addEventListener('click', function (e) {
            var btn = e.target.closest('.vex-opt');
            if (!btn || vexState.rendering) return;
            this.querySelectorAll('.vex-opt').forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
            vexState.format = btn.dataset.vfmt;
            // Also update main export format to keep in sync
            setExportFormat(vexState.format);
            updateVexStats();
        });

        document.getElementById('vexDurationGroup').addEventListener('click', function (e) {
            var btn = e.target.closest('.vex-opt');
            if (!btn || vexState.rendering) return;
            this.querySelectorAll('.vex-opt').forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
            vexState.duration = parseInt(btn.dataset.vdur);
            updateVexStats();
        });

        document.getElementById('vexQualityGroup').addEventListener('click', function (e) {
            var btn = e.target.closest('.vex-opt');
            if (!btn || vexState.rendering) return;
            this.querySelectorAll('.vex-opt').forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
            vexState.bitrate = parseInt(btn.dataset.br);
            updateVexStats();
        });

        document.getElementById('vexOutputGroup').addEventListener('click', function (e) {
            var btn = e.target.closest('.vex-opt');
            if (!btn || vexState.rendering) return;
            this.querySelectorAll('.vex-opt').forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
            vexState.output = btn.dataset.vout;
            updateVexStats();
        });

        // Escape key to close modal
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && document.getElementById('vexOverlay').classList.contains('open')) {
                closeVex();
            }
        });

        function vexSetProgress(pct, text) {
            var prog = document.getElementById('vexProgress');
            var fill = document.getElementById('vexProgressFill');
            var txt = document.getElementById('vexProgressText');
            prog.classList.add('active');
            fill.style.width = pct + '%';
            if (txt) txt.textContent = text || (pct + '%');
        }

        async function vexRender() {
            if (vexState.rendering) return;
            vexState.rendering = true;

            var renderBtn = document.getElementById('vexRenderBtn');
            renderBtn.disabled = true;
            renderBtn.innerHTML = '⏺ RENDERING...';

            // Get the real selected card (not the preview clone)
            var card = document.querySelector('.card.selected') || document.querySelector('.card');
            if (!card) {
                vexState.rendering = false;
                renderBtn.disabled = false;
                renderBtn.innerHTML = '🎬 Render Video';
                return;
            }

            var fps = 30;
            var scale = 2;
            var durationSec = vexState.duration;
            var totalFrames = durationSec * fps;
            var bitrate = vexState.bitrate;

            // Ensure html2canvas & mp4-muxer are loaded
            if (typeof html2canvas === 'undefined') {
                vexSetProgress(2, 'Loading export engine...');
                await new Promise(function (resolve, reject) {
                    var s = document.createElement('script');
                    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    s.onload = resolve; s.onerror = reject;
                    document.head.appendChild(s);
                });
            }

            vexSetProgress(5, 'Preparing card snapshot...');

            // Enable hover state for snapshot
            card.classList.add('recording-active');
            card.dispatchEvent(new MouseEvent('mouseenter'));
            await new Promise(function (r) { setTimeout(r, 1000); });

            // Hide UI overlays on the real card
            var hideEls = [card.querySelector('.card-toolbar'), card.querySelector('.select-check'), card.querySelector('.saved-badge'), card.querySelector('.product-url'), card.querySelector('.tpl-switcher')];
            hideEls.forEach(function (el) { if (el) el.style.display = 'none'; });

            var recEl = card.querySelector('.cinema-rec');
            if (recEl) recEl.classList.add('active');

            // Take hi-res snapshot
            var snapshot = await html2canvas(card, { scale: scale, useCORS: true, backgroundColor: null, logging: false });

            // Use the selected format dimensions
            var dims = vexState.format.split('x');
            var cw = parseInt(dims[0]) * scale;
            var ch = parseInt(dims[1]) * scale;

            vexSetProgress(10, 'Starting encoding...');

            var forceWebM = (vexState.output === 'webm');
            var useMP4 = !forceWebM && ('VideoEncoder' in window) && await loadMp4Muxer();

            if (useMP4) {
                await vexExportMP4(card, snapshot, cw, ch, fps, totalFrames, durationSec, bitrate, hideEls, recEl);
            } else {
                await vexExportWebM(card, snapshot, cw, ch, fps, totalFrames, durationSec, bitrate, hideEls, recEl);
            }

            // Reset
            vexState.rendering = false;
            renderBtn.disabled = false;
            renderBtn.innerHTML = '🎬 Render Video';
        }

        async function vexExportMP4(card, snapshot, cw, ch, fps, totalFrames, durationSec, bitrate, hideEls, recEl) {
            vexSetProgress(12, 'Encoding MP4 (WebCodecs + mp4-muxer)...');

            var Muxer = window.Mp4Muxer.Muxer;
            var muxer = new Muxer({
                target: new window.Mp4Muxer.ArrayBufferTarget(),
                video: { codec: 'avc', width: cw, height: ch },
                fastStart: 'in-memory'
            });

            var encoder = new VideoEncoder({
                output: function (chunk, meta) { muxer.addVideoChunk(chunk, meta); },
                error: function (e) { console.error('VideoEncoder error:', e); }
            });

            encoder.configure({
                codec: 'avc1.640028',
                width: cw,
                height: ch,
                bitrate: bitrate,
                framerate: fps,
                hardwareAcceleration: 'prefer-hardware'
            });

            var offscreen = new OffscreenCanvas(cw, ch);
            var offCtx = offscreen.getContext('2d');

            for (var i = 0; i < totalFrames; i++) {
                var t = i / totalFrames;
                drawCinematicFrame(offCtx, cw, ch, t, snapshot);

                var frame = new VideoFrame(offscreen, {
                    timestamp: i * (1000000 / fps),
                    duration: 1000000 / fps
                });
                encoder.encode(frame, { keyFrame: i % (fps * 2) === 0 });
                frame.close();

                if (i % 5 === 0) {
                    var pct = 12 + Math.round((i / totalFrames) * 82);
                    vexSetProgress(pct, 'Encoding: ' + Math.round((i / totalFrames) * 100) + '% (' + i + '/' + totalFrames + ')');
                    await new Promise(function (r) { setTimeout(r, 0); });
                }
            }

            vexSetProgress(95, 'Finalizing...');
            await encoder.flush();
            encoder.close();
            muxer.finalize();

            var buffer = muxer.target.buffer;
            var blob = new Blob([buffer], { type: 'video/mp4' });

            // Cleanup card
            hideEls.forEach(function (el) { if (el) el.style.display = ''; });
            if (recEl) recEl.classList.remove('active');
            card.classList.remove('recording-active');

            // Download
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'hellocomp-' + (card.dataset.tpl || 'card') + '-' + vexState.format + '-' + durationSec + 's.mp4';
            a.click();
            URL.revokeObjectURL(url);

            vexSetProgress(100, 'Done! MP4 exported (' + (blob.size / 1024 / 1024).toFixed(1) + ' MB)');
            setStatus('🎬 MP4 exported! (' + (blob.size / 1024 / 1024).toFixed(1) + ' MB) — ' + durationSec + 's ' + vexState.format, '#34d399');
        }

        async function vexExportWebM(card, snapshot, cw, ch, fps, totalFrames, durationSec, bitrate, hideEls, recEl) {
            vexSetProgress(12, 'Recording WebM (VP9)...');

            var recCanvas = document.createElement('canvas');
            recCanvas.width = cw;
            recCanvas.height = ch;
            var recCtx = recCanvas.getContext('2d');

            var stream = recCanvas.captureStream(fps);
            var mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
                ? 'video/webm;codecs=vp9'
                : 'video/webm;codecs=vp8';
            var recorder = new MediaRecorder(stream, {
                mimeType: mimeType,
                videoBitsPerSecond: bitrate
            });
            var chunks = [];
            recorder.ondataavailable = function (e) { if (e.data.size > 0) chunks.push(e.data); };

            return new Promise(function (resolve) {
                recorder.onstop = function () {
                    hideEls.forEach(function (el) { if (el) el.style.display = ''; });
                    if (recEl) recEl.classList.remove('active');
                    card.classList.remove('recording-active');

                    var blob = new Blob(chunks, { type: 'video/webm' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'hellocomp-' + (card.dataset.tpl || 'card') + '-' + vexState.format + '-' + durationSec + 's.webm';
                    a.click();
                    URL.revokeObjectURL(url);

                    vexSetProgress(100, 'Done! WebM exported (' + (blob.size / 1024 / 1024).toFixed(1) + ' MB)');
                    setStatus('🎬 WebM exported! (' + (blob.size / 1024 / 1024).toFixed(1) + ' MB) — ' + durationSec + 's ' + vexState.format, '#34d399');
                    resolve();
                };

                recorder.start();
                var frameCount = 0;

                function renderFrame() {
                    if (frameCount >= totalFrames) { recorder.stop(); return; }
                    var t = frameCount / totalFrames;
                    drawCinematicFrame(recCtx, cw, ch, t, snapshot);
                    frameCount++;
                    if (frameCount % 5 === 0) {
                        var pct = 12 + Math.round((frameCount / totalFrames) * 82);
                        vexSetProgress(pct, 'Recording: ' + Math.round((frameCount / totalFrames) * 100) + '%');
                    }
                    requestAnimationFrame(renderFrame);
                }
                renderFrame();
            });
        }

        // ─── Auto-load Heureka data + render on page load ───
        window.addEventListener('DOMContentLoaded', async () => {
            await loadFromCache();
            renderCards();
        });
    </script>

</body>

</html>